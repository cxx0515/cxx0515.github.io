<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å°å­¦æ•°å­¦è®¡ç®—ç»ƒä¹ ç”Ÿæˆå™¨</title>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <!-- å¹´çº§é…ç½®æ–‡ä»¶ -->
    <script src="js/gradeConfig.js"></script>
    <!-- å„å¹´çº§é¢˜ç›®ç”Ÿæˆå™¨ -->
    <script src="js/Grade1ExerciseGenerator.js"></script>
    <script src="js/Grade2ExerciseGenerator.js"></script>
    <script src="js/Grade3ExerciseGenerator.js"></script>
    <script src="js/Grade4ExerciseGenerator.js"></script>
    <script src="js/Grade5ExerciseGenerator.js"></script>
    <script src="js/Grade6ExerciseGenerator.js"></script>
    <!-- å·¥å‚ç±» -->
    <script src="js/ExerciseGeneratorFactory.js"></script>
    <!-- ä¸»æ§åˆ¶å™¨ -->
    <script src="js/MathExerciseGenerator.js"></script>
    <style>
        * {
            box-sizing: border-box;
            font-family: 'Microsoft YaHei', 'å¾®è½¯é›…é»‘', Arial, sans-serif;
        }
        
        /* å¹´çº§é€‰æ‹©é¢æ¿æ ·å¼ */
        .grade-selection-panel {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
            border: none;
        }
        
        .grade-selection-panel .panel-title {
            color: white;
            text-align: center;
            margin-bottom: 20px;
            font-size: 22px;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }
        
        .grade-selector-container {
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .grade-select {
            padding: 15px 25px;
            font-size: 20px;
            font-weight: bold;
            border: none;
            border-radius: 50px;
            background: white;
            color: #667eea;
            cursor: pointer;
            outline: none;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            appearance: none;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23667eea' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 1rem center;
            background-size: 1em;
        }
        
        .grade-select:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.25);
        }
        
        .grade-select:focus {
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.25), 0 0 0 4px rgba(102, 126, 234, 0.3);
        }
        
        /* å¹´çº§æŒ‰é’®æ ·å¼ */
        .grade-buttons-container {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 15px;
            padding: 10px;
        }
        
        .grade-button {
            padding: 15px 25px;
            font-size: 18px;
            font-weight: bold;
            border: none;
            border-radius: 50px;
            background: rgba(255, 255, 255, 0.9);
            color: #667eea;
            cursor: pointer;
            outline: none;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            min-width: 120px;
        }
        
        .grade-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
            background: white;
        }
        
        .grade-button.selected {
            background: #667eea;
            color: white;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.25), 0 0 0 4px rgba(102, 126, 234, 0.3);
        }
        
        .grade-button:focus {
            outline: none;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.25), 0 0 0 4px rgba(102, 126, 234, 0.3);
        }
        
        /* ä¸»é¢˜é€‰æ‹©æ¡†ç¾åŒ– */        .unit-box {
            background: linear-gradient(135deg, #f5f7fa 0%, #e4edf9 100%);
            border-radius: 12px;
            padding: 20px;
            border: 1px solid #d0d9ff;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
            transition: all 0.3s ease;
        }
        
        .unit-box:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.12);
        }
        
        .unit-title {
            font-size: 20px;
            color: #2c3e50;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #4a6baf;
            font-weight: 600;
        }
        
        .topic-checkbox input[type="checkbox"] {
            width: 20px;
            height: 20px;
            border-radius: 5px;
            border: 2px solid #4a6baf;
            appearance: none;
            position: relative;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .topic-checkbox input[type="checkbox"]:checked {
            background-color: #4a6baf;
        }
        
        .topic-checkbox input[type="checkbox"]:checked::before {
            content: "âœ“";
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-weight: bold;
            font-size: 14px;
        }
        
        .topic-checkbox label {
            font-size: 16px;
            cursor: pointer;
            margin-left: 10px;
            color: #333;
            transition: color 0.2s ease;
        }
        
        .topic-checkbox:hover label {
            color: #4a6baf;
        }
        
        body {
            margin: 0;
            padding: 20px;
            background-color: #f5f7fa;
            color: #333;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: white;
            border-radius: 12px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.08);
            padding: 25px;
        }
        
        header {
            text-align: center;
            margin-bottom: 30px;
            border-bottom: 2px solid #4a6baf;
            padding-bottom: 15px;
        }
        
        h1 {
            color: #2c3e50;
            margin-bottom: 8px;
            font-size: 32px;
        }
        
        .subtitle {
            color: #4a6baf;
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 10px;
        }
        
        .textbook-info {
            color: #666;
            font-size: 16px;
            line-height: 1.6;
            max-width: 800px;
            margin: 0 auto;
            padding: 10px 0;
        }
        
        .textbook-info p {
            margin: 8px 0;
        }
        
        .info-line {
            display: flex;
            justify-content: space-between;
            font-size: 16px;
            margin-bottom: 5px;
        }
        
        .control-panel {
            background-color: #f0f4ff;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 30px;
            border: 1px solid #d0d9ff;
        }
        
        .panel-title {
            font-size: 20px;
            color: #4a6baf;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
        }
        
        .panel-title i {
            margin-right: 10px;
            font-size: 24px;
        }
        
        .units-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }
        
        .unit-box {
            background-color: white;
            border-radius: 8px;
            padding: 15px;
            border: 1px solid #d0d9ff;
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.05);
        }
        
        .unit-title {
            font-size: 18px;
            color: #2c3e50;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 1px dashed #d0d9ff;
        }
        
        .topics-list {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .topic-checkbox {
            display: flex;
            align-items: center;
            margin-bottom: 5px;
        }
        
        .topic-checkbox input {
            margin-right: 6px;
        }
        
        .topic-checkbox label {
            font-size: 15px;
            cursor: pointer;
        }
        
        .difficulty-container {
            display: flex;
            gap: 20px;
            margin-bottom: 25px;
        }
        
        .difficulty-option {
            flex: 1;
            background-color: white;
            border-radius: 8px;
            padding: 15px;
            border: 1px solid #d0d9ff;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .difficulty-option:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 12px rgba(0, 0, 0, 0.08);
        }
        
        .difficulty-option.selected {
            border-color: #4a6baf;
            background-color: #f0f4ff;
        }
        
        .difficulty-title {
            font-size: 17px;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 8px;
        }
        
        .difficulty-desc {
            font-size: 14px;
            color: #666;
            line-height: 1.4;
        }
        
        .settings-row {
            display: flex;
            gap: 20px;
            margin-bottom: 15px;
        }
        
        .setting-item {
            flex: 1;
        }
        
        .setting-item label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #4a6baf;
        }
        
        .setting-item input, .setting-item select {
            width: 100%;
            padding: 10px;
            border: 1px solid #d0d9ff;
            border-radius: 6px;
            font-size: 15px;
        }
        
        .number-input-container {
            position: relative;
        }
        
        .number-input-container input {
            padding-right: 40px;
        }
        
        .number-arrows {
            position: absolute;
            right: 5px;
            top: 50%;
            transform: translateY(-50%);
            display: flex;
            flex-direction: column;
            width: 20px;
        }
        
        .number-arrow {
            background: none;
            border: none;
            font-size: 12px;
            color: #4a6baf;
            cursor: pointer;
            padding: 2px;
            height: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .number-arrow:hover {
            color: #3a5a9f;
            background-color: #f0f4ff;
            border-radius: 2px;
        }
        
        .buttons-container {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 25px;
            flex-wrap: wrap;
        }
        
        .btn {
            padding: 12px 25px;
            font-size: 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            min-width: 140px;
        }
        
        .btn-primary {
            background-color: #4a6baf;
            color: white;
        }
        
        .btn-primary:hover {
            background-color: #3a5a9f;
        }
        
        .btn-secondary {
            background-color: #f0f4ff;
            color: #4a6baf;
            border: 1px solid #4a6baf;
        }
        
        .btn-secondary:hover {
            background-color: #e0e8ff;
        }
        
        .btn-warning {
            background-color: #ff9800;
            color: white;
            border: 1px solid #e68900;
        }
        
        .btn-warning:hover {
            background-color: #e68900;
        }
        
        .btn-success {
            background-color: #4CAF50;
            color: white;
            border: 1px solid #45a049;
        }
        
        .btn-success:hover {
            background-color: #45a049;
        }
        
        .btn-icon {
            font-size: 18px;
        }
        
        .exercises-container {
            margin-top: 30px;
            background-color: white;
            border-radius: 8px;
            padding: 20px;
            border: 1px solid #d0d9ff;
            position: relative;
            min-height: 400px;
        }
        
        .exercises-title {
            font-size: 20px;
            color: #4a6baf;
            margin-bottom: 20px;
            text-align: center;
        }
        
        #exercisesContent {
            line-height: 1.5;
            padding: 10px;
        }
        
        /* ä¿®æ”¹é¡µé¢å®¹å™¨ä¸ºA4æ¯”ä¾‹ (21:29.7) */
        .page-a4 {
            width: 210mm;
            min-height: 297mm; /* å›ºå®šé«˜åº¦ä¸ºA4çº¸çš„é«˜åº¦ */
            aspect-ratio: 21 / 29.7; /* æ·»åŠ å®½é«˜æ¯”ç¡®ä¿æ¯”ä¾‹æ­£ç¡® */
            margin: 0 auto;
            padding: 20mm 15mm; /* è°ƒæ•´å†…è¾¹è·ä»¥é€‚åº”A4æ¯”ä¾‹ */
            background: white;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            position: relative;
            page-break-after: always;
            margin-bottom: 20px;
            overflow: hidden; /* é˜²æ­¢å†…å®¹æº¢å‡º */
        }
        
        .page-a4:last-child {
            page-break-after: auto;
        }
        
        .exercise-header {
            text-align: center;
            margin-bottom: 20px; /* å‡å°æ ‡é¢˜ä¸‹è¾¹è· */
        }
        
        .exercise-header h2 {
            margin: 0;
            font-size: 26px; /* å‡å°æ ‡é¢˜å­—å· */
            color: #2c3e50;
        }
        
        .exercise-header .info {
            margin-top: 12px; /* å‡å°ä¿¡æ¯è¡Œä¸Šè¾¹è· */
            font-size: 15px; /* å‡å°ä¿¡æ¯è¡Œå­—å· */
            display: flex;
            justify-content: space-between;
        }
        
        .exercises-grid {
            display: grid;
            gap: 20px 30px; /* å¢åŠ åˆ—é—´è·ï¼ˆä»15pxå¢åŠ åˆ°30pxï¼‰ï¼Œå‡å°è¡Œé—´è· */
            margin-top: 20px; /* å‡å°ç½‘æ ¼ä¸Šè¾¹è· */
        }
        
        .exercise-item {
            padding: 6px 0; /* è°ƒæ•´å†…è¾¹è· */
            display: flex;
            align-items: center;
            white-space: nowrap;
            overflow: hidden;
            min-height: 32px; /* ä¿æŒåˆé€‚çš„æœ€å°é«˜åº¦ */
            line-height: 1.3; /* åˆé€‚çš„è¡Œé«˜ */
        }
        
        .exercise-item span {
            min-width: 150px; /* ç¨å¾®å¢åŠ æœ€å°å®½åº¦ï¼Œç»™é¢˜ç›®æ›´å¤šç©ºé—´ */
            display: inline-block;
            margin-right: 12px; /* ç¨å¾®å¢åŠ å³è¾¹è· */
        }
        
        .exercise-item:after {
            content: "";
            flex: 1;
            border-bottom: 1.5px dotted #999; /* å‡å°è™šçº¿ç²—ç»† */
            margin-left: 10px; /* ç¨å¾®å¢åŠ å·¦è¾¹è· */
        }
        
        .loading {
            display: none;
            text-align: center;
            padding: 40px;
            font-size: 18px;
            color: #4a6baf;
        }
        
        .loading.active {
            display: block;
        }
        
        .pagination-info {
            text-align: center;
            margin-top: 20px;
            font-size: 16px;
            color: #4a6baf;
            font-weight: bold;
        }
        
        @media print {
            body * {
                visibility: hidden;
            }
            
            .page-a4, .page-a4 * {
                visibility: visible;
            }
            
            .page-a4 {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                height: 100%;
                box-shadow: none;
                margin: 0;
                padding: 15mm 10mm;
            }
            
            .buttons-container, .exercises-title, .pagination-info {
                display: none;
            }
        }
        
        @media (max-width: 1100px) {
            .page-a4 {
                width: 100%;
                padding: 15px;
            }
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }
            
            .units-container {
                grid-template-columns: 1fr;
            }
            
            .difficulty-container {
                flex-direction: column;
            }
            
            .settings-row {
                flex-direction: column;
            }
            
            .buttons-container {
                flex-direction: column;
                align-items: center;
            }
            
            .btn {
                width: 100%;
                max-width: 300px;
            }
            
            .grade-selection-panel {
                padding: 20px 15px;
            }
            
            .grade-select {
                padding: 12px 20px;
                font-size: 18px;
                width: 100%;
                max-width: 300px;
            }
        }
        
        .setting-item:last-child {
            display: none;
        }
        
        /* ç­”æ¡ˆæ ·å¼ */
        .answer-page-a4 {
            width: 210mm;
            min-height: 297mm;
            aspect-ratio: 21 / 29.7;
            margin: 0 auto;
            padding: 20mm 15mm;
            background: white;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            position: relative;
            page-break-after: always;
            margin-bottom: 20px;
            overflow: hidden;
        }
        
        .answer-header {
            text-align: center;
            margin-bottom: 20px;
        }
        
        .answer-header h2 {
            margin: 0;
            font-size: 24px; /* ç­”æ¡ˆæ ‡é¢˜ç¨å° */
            color: #2c3e50;
        }
        
        .answer-header .info {
            margin-top: 10px;
            font-size: 14px; /* ç­”æ¡ˆä¿¡æ¯è¡Œæ›´å° */
            display: flex;
            justify-content: space-between;
        }
        
        .answers-grid {
            display: grid;
            gap: 18px 25px; /* ç­”æ¡ˆç½‘æ ¼é—´è·ç¨å° */
            margin-top: 18px;
        }
        
        .answer-item {
            padding: 5px 0;
            display: flex;
            align-items: center;
            white-space: nowrap;
            overflow: hidden;
            min-height: 28px;
            line-height: 1.2;
            font-size: 14px; /* é»˜è®¤ç­”æ¡ˆå­—å·è¾ƒå° */
        }
        
        .answer-item span {
            min-width: 200px; /* ç­”æ¡ˆéœ€è¦æ›´å®½çš„ç©ºé—´ */
            display: inline-block;
            margin-right: 10px;
        }
        
        .answer-item:after {
            content: "";
            flex: 1;
            border-bottom: 1px dotted #999; /* ç­”æ¡ˆè™šçº¿æ›´ç»† */
            margin-left: 8px;
        }
        
        /* ä¸“é—¨ä¸ºç­”æ¡ˆè°ƒæ•´çš„å°å­—å· */
        .small-font .answer-item {
            font-size: 12px !important;
        }
        
        .small-font .answer-item span {
            min-width: 220px;
        }
        
        /* æ–°å¢ï¼šæˆªå›¾ä¼˜åŒ–æ ·å¼ */
        .screenshot-mode {
            transform-origin: 0 0;
            transform: scale(1);
            -webkit-font-smoothing: antialiased !important;
            -moz-osx-font-smoothing: grayscale !important;
            text-rendering: geometricPrecision !important;
        }
        
        .screenshot-mode * {
            -webkit-font-smoothing: antialiased !important;
            -moz-osx-font-smoothing: grayscale !important;
            text-rendering: geometricPrecision !important;
        }
        
        .screenshot-mode .page-a4,
        .screenshot-mode .answer-page-a4 {
            box-shadow: 0 0 1px rgba(0, 0, 0, 0.1) !important;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>ä¸‰å¹´çº§è®¡ç®—ç»ƒä¹ ç”Ÿæˆå™¨</h1>
            <div class="subtitle">åŒ—å¸ˆå¤§ç‰ˆä¸‰å¹´çº§æ•°å­¦ï¼ˆä¸Šå†Œï¼‰è®¡ç®—é¢˜ç»ƒä¹ </div>
            <div class="textbook-info">
                <!-- åˆ é™¤åŸäººæ•™ç‰ˆæ•™æè¯´æ˜ï¼Œä»…ä¿ç•™ç®€çŸ­çš„æ ‡é¢˜ä¿¡æ¯ -->
            </div>
        </header>
        
        <!-- å¹´çº§é€‰æ‹©é¢æ¿ -->
        <div class="grade-selection-panel">
            <div class="panel-title">
                <span>ğŸ“š å¹´çº§é€‰æ‹©</span>
            </div>
            <div class="grade-buttons-container">
                <button class="grade-button" data-grade="1">ä¸€å¹´çº§</button>
                <button class="grade-button" data-grade="2">äºŒå¹´çº§</button>
                <button class="grade-button selected" data-grade="3">ä¸‰å¹´çº§</button>
                <button class="grade-button" data-grade="4">å››å¹´çº§</button>
                <button class="grade-button" data-grade="5">äº”å¹´çº§</button>
                <button class="grade-button" data-grade="6">å…­å¹´çº§</button>
            </div>
        </div>
        
        <div class="control-panel">
            <div class="panel-title">
                <span>ğŸ“š å•å…ƒä¸ä¸»é¢˜é€‰æ‹©</span>
            </div>
            
            <div class="units-container">
                <div class="unit-box">
                    <div class="unit-title">ç¬¬ä¸€å•å…ƒï¼šæ··åˆè¿ç®—</div>
                    <div class="topics-list">
                        <div class="topic-checkbox">
                            <input type="checkbox" id="topic1" name="topic" value="ä¹˜åŠ ">
                            <label for="topic1">ä¹˜åŠ è¿ç®— (a+bÃ—c)</label>
                        </div>
                        <div class="topic-checkbox">
                            <input type="checkbox" id="topic2" name="topic" value="ä¹˜å‡">
                            <label for="topic2">ä¹˜å‡è¿ç®— (a-bÃ—c)</label>
                        </div>
                        <div class="topic-checkbox">
                            <input type="checkbox" id="topic3" name="topic" value="é™¤åŠ ">
                            <label for="topic3">é™¤åŠ è¿ç®— (a+eÃ·c)</label>
                        </div>
                        <div class="topic-checkbox">
                            <input type="checkbox" id="topic4" name="topic" value="é™¤å‡">
                            <label for="topic4">é™¤å‡è¿ç®— (a-eÃ·c)</label>
                        </div>
                        <div class="topic-checkbox">
                            <input type="checkbox" id="topic5" name="topic" value="å°æ‹¬å·">
                            <label for="topic5">å¸¦å°æ‹¬å·çš„è¿ç®—</label>
                        </div>
                    </div>
                </div>
                
                <!-- ä¿®æ”¹ç‚¹ï¼šæœŸæœ«å¤ä¹  -->
                <div class="unit-box">
                    <div class="unit-title">æœŸæœ«å¤ä¹ ï¼šæ··åˆè¿ç®—</div>
                    <div class="topics-list">
                        <div class="topic-checkbox">
                            <input type="checkbox" id="topic11" name="topic" value="å¤ä¹ ä¹˜åŠ ">
                            <label for="topic11">ä¹˜åŠ è¿ç®— (å¤ä¹ )</label>
                        </div>
                        <div class="topic-checkbox">
                            <input type="checkbox" id="topic12" name="topic" value="å¤ä¹ ä¹˜å‡">
                            <label for="topic12">ä¹˜å‡è¿ç®— (å¤ä¹ )</label>
                        </div>
                        <div class="topic-checkbox">
                            <input type="checkbox" id="topic13" name="topic" value="å¤ä¹ é™¤åŠ ">
                            <label for="topic13">é™¤åŠ è¿ç®— (å¤ä¹ )</label>
                        </div>
                        <div class="topic-checkbox">
                            <input type="checkbox" id="topic14" name="topic" value="å¤ä¹ é™¤å‡">
                            <label for="topic14">é™¤å‡è¿ç®— (å¤ä¹ )</label>
                        </div>
                        <div class="topic-checkbox">
                            <input type="checkbox" id="topic15" name="topic" value="å¤ä¹ å°æ‹¬å·">
                            <label for="topic15">å¸¦å°æ‹¬å·çš„è¿ç®— (å¤ä¹ )</label>
                        </div>
                    </div>
                </div>
                
                <div class="unit-box">
                    <div class="unit-title">ç¬¬ä¸‰å•å…ƒï¼šä¸‰ä½æ•°åŠ å‡</div>
                    <div class="topics-list">
                        <div class="topic-checkbox">
                            <input type="checkbox" id="topic6" name="topic" value="ä¸‰ä½æ•°åŠ å‡">
                            <label for="topic6">ä¸‰ä½æ•°åŠ å‡æ··åˆè¿ç®—</label>
                        </div>
                    </div>
                </div>
                
                <div class="unit-box">
                    <div class="unit-title">ç¬¬å…­å•å…ƒï¼šä¹˜é™¤æ³•è¿ç®—</div>
                    <div class="topics-list">
                        <div class="topic-checkbox">
                            <input type="checkbox" id="topic7" name="topic" value="ä¸¤ä½æ•°ä¹˜ä¸€ä½æ•°">
                            <label for="topic7">ä¸¤ä½æ•°ä¹˜ä¸€ä½æ•°</label>
                        </div>
                        <div class="topic-checkbox">
                            <input type="checkbox" id="topic8" name="topic" value="ä¸¤ä½æ•°é™¤ä¸€ä½æ•°">
                            <label for="topic8">ä¸¤ä½æ•°é™¤ä¸€ä½æ•°</label>
                        </div>
                    </div>
                </div>
                
                <div class="unit-box">
                    <div class="unit-title">ç¬¬ä¸ƒå•å…ƒï¼šå°æ•°è¿ç®—</div>
                    <div class="topics-list">
                        <div class="topic-checkbox">
                            <input type="checkbox" id="topic9" name="topic" value="å°æ•°åŠ æ³•">
                            <label for="topic9">å°æ•°åŠ æ³•</label>
                        </div>
                        <div class="topic-checkbox">
                            <input type="checkbox" id="topic10" name="topic" value="å°æ•°å‡æ³•">
                            <label for="topic10">å°æ•°å‡æ³•</label>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="panel-title" style="margin-top: 20px;">
                <span>ğŸ“Š éš¾åº¦ä¸è®¾ç½®</span>
            </div>
            
            <div class="difficulty-container">
                <div class="difficulty-option" data-level="easy">
                    <div class="difficulty-title">åŸºç¡€éš¾åº¦</div>
                    <div class="difficulty-desc">é¢˜ç›®è¾ƒä¸ºç®€å•ï¼Œé€‚åˆå·©å›ºåŸºç¡€çŸ¥è¯†å’Œè¯¾å ‚ç»ƒä¹ </div>
                </div>
                <div class="difficulty-option selected" data-level="medium">
                    <div class="difficulty-title">ä¸­ç­‰éš¾åº¦</div>
                    <div class="difficulty-desc">é¢˜ç›®éš¾åº¦é€‚ä¸­ï¼Œç¬¦åˆå¤§éƒ¨åˆ†å­¦ç”Ÿæ°´å¹³ï¼Œé€‚åˆè¯¾åç»ƒä¹ </div>
                </div>
                <div class="difficulty-option" data-level="hard">
                    <div class="difficulty-title">æŒ‘æˆ˜éš¾åº¦</div>
                    <div class="difficulty-desc">é¢˜ç›®è¾ƒä¸ºå¤æ‚ï¼Œé€‚åˆå­¦æœ‰ä½™åŠ›çš„å­¦ç”Ÿè¿›è¡Œèƒ½åŠ›æå‡</div>
                </div>
            </div>
            
            <div class="settings-row">
                <div class="setting-item">
                    <label for="perRow">æ¯è¡Œé¢˜ç›®æ•°é‡</label>
                    <select id="perRow">
                        <option value="3">3é¢˜/è¡Œ</option>
                        <option value="4" selected>4é¢˜/è¡Œ</option>
                        <option value="5">5é¢˜/è¡Œ</option>
                        <option value="6">6é¢˜/è¡Œ</option>
                    </select>
                </div>
                <div class="setting-item">
                    <label for="totalCount">é¢˜ç›®æ€»æ•°</label>
                    <div class="number-input-container">
                        <!-- ä¿®æ”¹ç‚¹ï¼šå°†é»˜è®¤æ€»é¢˜æ•°è®¾ä¸º68 -->
                        <input type="number" id="totalCount" min="10" max="200" value="68" step="10">
                        <div class="number-arrows">
                            <button class="number-arrow" id="increaseBtn">â–²</button>
                            <button class="number-arrow" id="decreaseBtn">â–¼</button>
                        </div>
                    </div>
                </div>
                <div class="setting-item" style="display: none;">
                    <label for="autoFontSize">è‡ªåŠ¨è°ƒæ•´å­—å·</label>
                    <select id="autoFontSize">
                        <option value="auto" selected>è‡ªåŠ¨è°ƒæ•´</option>
                        <option value="fixed">å›ºå®šå­—å·</option>
                    </select>
                </div>
            </div>
            
            <div class="buttons-container">
                <button class="btn btn-warning" id="clearBtn">
                    <span class="btn-icon">ğŸ—‘ï¸</span> æ¸…é™¤è®¾ç½®
                </button>
                <button class="btn btn-secondary" id="selectAllBtn">
                    <span class="btn-icon">âœ“</span> å…¨é€‰ä¸»é¢˜
                </button>
                <button class="btn btn-primary" id="generateBtn">
                    <span class="btn-icon">ğŸ“</span> ç”Ÿæˆç»ƒä¹ é¢˜
                </button>
                <button class="btn btn-secondary" id="exportBtn">
                    <span class="btn-icon">ğŸ–¼ï¸</span> é¢˜ç›®å¯¼å‡ºä¸ºå›¾ç‰‡
                </button>
                <button class="btn btn-secondary" id="printBtn">
                    <span class="btn-icon">ğŸ–¨ï¸</span> ç›´æ¥æ‰“å°é¢˜ç›®
                </button>
                <button class="btn btn-success" id="exportAnswerBtn">
                    <span class="btn-icon">âœ…</span> å¯¼å‡ºç­”æ¡ˆ
                </button>
            </div>
        </div>
        
        <div class="exercises-container">
            <div class="exercises-title">ç»ƒä¹ é¢˜é¢„è§ˆåŒºåŸŸ</div>
            <div class="loading" id="loadingIndicator">æ­£åœ¨ç”Ÿæˆé¢˜ç›®ï¼Œè¯·ç¨å€™...</div>
            <div id="exercisesContent">
                <!-- é¢˜ç›®å°†åŠ¨æ€ç”Ÿæˆåœ¨è¿™é‡Œ -->
            </div>
            <div class="pagination-info" id="paginationInfo"></div>
        </div>
    </div>

    <script>
        // å…¨å±€å˜é‡
        let currentDifficulty = 'medium';
        let selectedTopics = [];
        let exercises = [];
        let currentPages = [];
        let exercisesGenerated = false; // æ ‡è®°é¢˜ç›®æ˜¯å¦å·²ç”Ÿæˆ
        let exerciseAnswers = []; // å­˜å‚¨é¢˜ç›®ç­”æ¡ˆ
        
        // è¡¨å†…ä¹˜æ³•ç»“æœé›†
        const multiplicationFacts = [
            [2,2,4], [2,3,6], [2,4,8], [2,5,10], [2,6,12], [2,7,14], [2,8,16], [2,9,18],
            [3,2,6], [3,3,9], [3,4,12], [3,5,15], [3,6,18], [3,7,21], [3,8,24], [3,9,27],
            [4,2,8], [4,3,12], [4,4,16], [4,5,20], [4,6,24], [4,7,28], [4,8,32], [4,9,36],
            [5,2,10], [5,3,15], [5,4,20], [5,5,25], [5,6,30], [5,7,35], [5,8,40], [5,9,45],
            [6,2,12], [6,3,18], [6,4,24], [6,5,30], [6,6,36], [6,7,42], [6,8,48], [6,9,54],
            [7,2,14], [7,3,21], [7,4,28], [7,5,35], [7,6,42], [7,7,49], [7,8,56], [7,9,63],
            [8,2,16], [8,3,24], [8,4,32], [8,5,40], [8,6,48], [8,7,56], [8,8,64], [8,9,72],
            [9,2,18], [9,3,27], [9,4,36], [9,5,45], [9,6,54], [9,7,63], [9,8,72], [9,9,81]
        ];
        
        // ======================================================
        // ä¿®æ”¹ç‚¹ï¼šä¿®å¤ä¸¤ä½æ•°é™¤ä»¥ä¸€ä½æ•°è¡¨ï¼Œç§»é™¤é™¤æ•°ä¸º10çš„æƒ…å†µ
        // ======================================================
        const twoDigitDivisionFacts = [
            // è¢«é™¤æ•°æ˜¯ä¸¤ä½æ•°ï¼Œé™¤æ•°æ˜¯ä¸€ä½æ•°ï¼Œä¸”èƒ½æ•´é™¤ï¼ˆé™¤æ•°åªèƒ½æ˜¯2-9ï¼‰
            [10,2,5], [12,2,6], [14,2,7], [16,2,8], [18,2,9],
            [20,2,10], [22,2,11], [24,2,12], [26,2,13], [28,2,14], [30,2,15], [32,2,16], [34,2,17], [36,2,18], [38,2,19],
            [40,2,20], [42,2,21], [44,2,22], [46,2,23], [48,2,24], [50,2,25], [52,2,26], [54,2,27], [56,2,28], [58,2,29],
            [60,2,30], [62,2,31], [64,2,32], [66,2,33], [68,2,34], [70,2,35], [72,2,36], [74,2,37], [76,2,38], [78,2,39],
            [80,2,40], [82,2,41], [84,2,42], [86,2,43], [88,2,44], [90,2,45], [92,2,46], [94,2,47], [96,2,48], [98,2,49],
            
            [15,3,5], [18,3,6], [21,3,7], [24,3,8], [27,3,9], [30,3,10], [33,3,11], [36,3,12], [39,3,13],
            [42,3,14], [45,3,15], [48,3,16], [51,3,17], [54,3,18], [57,3,19], [60,3,20], [63,3,21], [66,3,22], [69,3,23],
            [72,3,24], [75,3,25], [78,3,26], [81,3,27], [84,3,28], [87,3,29], [90,3,30], [93,3,31], [96,3,32], [99,3,33],
            
            [12,4,3], [16,4,4], [20,4,5], [24,4,6], [28,4,7], [32,4,8], [36,4,9], [40,4,10], [44,4,11], [48,4,12],
            [52,4,13], [56,4,14], [60,4,15], [64,4,16], [68,4,17], [72,4,18], [76,4,19], [80,4,20], [84,4,21], [88,4,22],
            [92,4,23], [96,4,24],
            
            [10,5,2], [15,5,3], [20,5,4], [25,5,5], [30,5,6], [35,5,7], [40,5,8], [45,5,9], [50,5,10], [55,5,11],
            [60,5,12], [65,5,13], [70,5,14], [75,5,15], [80,5,16], [85,5,17], [90,5,18], [95,5,19],
            
            [12,6,2], [18,6,3], [24,6,4], [30,6,5], [36,6,6], [42,6,7], [48,6,8], [54,6,9], [60,6,10], [66,6,11],
            [72,6,12], [78,6,13], [84,6,14], [90,6,15], [96,6,16],
            
            [14,7,2], [21,7,3], [28,7,4], [35,7,5], [42,7,6], [49,7,7], [56,7,8], [63,7,9], [70,7,10], [77,7,11],
            [84,7,12], [91,7,13], [98,7,14],
            
            [16,8,2], [24,8,3], [32,8,4], [40,8,5], [48,8,6], [56,8,7], [64,8,8], [72,8,9], [80,8,10], [88,8,11],
            [96,8,12],
            
            [18,9,2], [27,9,3], [36,9,4], [45,9,5], [54,9,6], [63,9,7], [72,9,8], [81,9,9], [90,9,10], [99,9,11]
        ];
        
        // ======================================================
        // ä¿®æ”¹ç‚¹ï¼šä¿®å¤å¤ä¹ å•å…ƒçš„ä¸¤ä½æ•°æ•´é™¤ä¸€ä½æ•°è¡¨ï¼Œç§»é™¤é™¤æ•°ä¸º10çš„æƒ…å†µ
        // ======================================================
        const reviewDivisionFacts = [
            // è¢«é™¤æ•°æ˜¯ä¸¤ä½æ•°ï¼Œé™¤æ•°æ˜¯ä¸€ä½æ•°ï¼Œä¸”èƒ½æ•´é™¤ï¼ˆé™¤æ•°åªèƒ½æ˜¯2-9ï¼‰
            [10,2,5], [12,2,6], [14,2,7], [16,2,8], [18,2,9],
            [20,2,10], [22,2,11], [24,2,12], [26,2,13], [28,2,14], [30,2,15], [32,2,16], [34,2,17], [36,2,18], [38,2,19],
            [40,2,20], [42,2,21], [44,2,22], [46,2,23], [48,2,24], [50,2,25], [52,2,26], [54,2,27], [56,2,28], [58,2,29],
            [60,2,30], [62,2,31], [64,2,32], [66,2,33], [68,2,34], [70,2,35], [72,2,36], [74,2,37], [76,2,38], [78,2,39],
            [80,2,40], [82,2,41], [84,2,42], [86,2,43], [88,2,44], [90,2,45], [92,2,46], [94,2,47], [96,2,48], [98,2,49],
            
            [15,3,5], [18,3,6], [21,3,7], [24,3,8], [27,3,9], [30,3,10], [33,3,11], [36,3,12], [39,3,13],
            [42,3,14], [45,3,15], [48,3,16], [51,3,17], [54,3,18], [57,3,19], [60,3,20], [63,3,21], [66,3,22], [69,3,23],
            [72,3,24], [75,3,25], [78,3,26], [81,3,27], [84,3,28], [87,3,29], [90,3,30], [93,3,31], [96,3,32], [99,3,33],
            
            [12,4,3], [16,4,4], [20,4,5], [24,4,6], [28,4,7], [32,4,8], [36,4,9], [40,4,10], [44,4,11], [48,4,12],
            [52,4,13], [56,4,14], [60,4,15], [64,4,16], [68,4,17], [72,4,18], [76,4,19], [80,4,20], [84,4,21], [88,4,22],
            [92,4,23], [96,4,24],
            
            [10,5,2], [15,5,3], [20,5,4], [25,5,5], [30,5,6], [35,5,7], [40,5,8], [45,5,9], [50,5,10], [55,5,11],
            [60,5,12], [65,5,13], [70,5,14], [75,5,15], [80,5,16], [85,5,17], [90,5,18], [95,5,19],
            
            [12,6,2], [18,6,3], [24,6,4], [30,6,5], [36,6,6], [42,6,7], [48,6,8], [54,6,9], [60,6,10], [66,6,11],
            [72,6,12], [78,6,13], [84,6,14], [90,6,15], [96,6,16],
            
            [14,7,2], [21,7,3], [28,7,4], [35,7,5], [42,7,6], [49,7,7], [56,7,8], [63,7,9], [70,7,10], [77,7,11],
            [84,7,12], [91,7,13], [98,7,14],
            
            [16,8,2], [24,8,3], [32,8,4], [40,8,5], [48,8,6], [56,8,7], [64,8,8], [72,8,9], [80,8,10], [88,8,11],
            [96,8,12],
            
            [18,9,2], [27,9,3], [36,9,4], [45,9,5], [54,9,6], [63,9,7], [72,9,8], [81,9,9], [90,9,10], [99,9,11]
        ];
        
        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            const difficultyOptions = document.querySelectorAll('.difficulty-option');
            difficultyOptions.forEach(option => {
                option.addEventListener('click', function() {
                    difficultyOptions.forEach(opt => opt.classList.remove('selected'));
                    this.classList.add('selected');
                    currentDifficulty = this.dataset.level;
                });
            });
            
            document.getElementById('decreaseBtn').addEventListener('click', function() {
                const totalCountInput = document.getElementById('totalCount');
                let value = parseInt(totalCountInput.value);
                value = Math.max(10, value - 10);
                totalCountInput.value = value;
            });
            
            document.getElementById('increaseBtn').addEventListener('click', function() {
                const totalCountInput = document.getElementById('totalCount');
                let value = parseInt(totalCountInput.value);
                value = Math.min(200, value + 10);
                totalCountInput.value = value;
            });
            
            // è·å–æ•°å­¦ç»ƒä¹ ç”Ÿæˆå™¨å®ä¾‹
            const mathExerciseGenerator = window.mathExerciseGenerator;
                    
            document.getElementById('generateBtn').addEventListener('click', () => {
                mathExerciseGenerator.generateExercises();
            });
            document.getElementById('exportBtn').addEventListener('click', () => {
                mathExerciseGenerator.exportToImages();
            });
            document.getElementById('printBtn').addEventListener('click', () => {
                mathExerciseGenerator.printExercises();
            });
            document.getElementById('exportAnswerBtn').addEventListener('click', () => {
                mathExerciseGenerator.exportAnswers();
            });
            document.getElementById('clearBtn').addEventListener('click', () => {
                mathExerciseGenerator.clearAllSettings();
            });
            
            // ä¿®æ”¹ï¼šé»˜è®¤ä¸å‹¾é€‰ä»»ä½•ä¸»é¢˜
            // ä¸å†è‡ªåŠ¨å‹¾é€‰æ‰€æœ‰ä¸»é¢˜
            
            // ç”Ÿæˆç»ƒä¹ é¢˜æ—¶ä¸å†è‡ªåŠ¨è°ƒç”¨ï¼Œç­‰å¾…ç”¨æˆ·ç‚¹å‡»æŒ‰é’®
        });
        
        // æ¸…é™¤æ‰€æœ‰è®¾ç½®
        function clearAllSettings() {
            // æ¸…é™¤æ‰€æœ‰é€‰ä¸­çš„ä¸»é¢˜
            document.querySelectorAll('input[name="topic"]:checked').forEach(checkbox => {
                checkbox.checked = false;
            });
            
            // é‡ç½®éš¾åº¦é€‰æ‹©åˆ°ä¸­ç­‰éš¾åº¦
            document.querySelectorAll('.difficulty-option').forEach(option => {
                option.classList.remove('selected');
            });
            document.querySelector('.difficulty-option[data-level="medium"]').classList.add('selected');
            currentDifficulty = 'medium';
            
            // é‡ç½®é¢˜ç›®æ€»æ•°
            document.getElementById('totalCount').value = 68;
            
            // é‡ç½®æ¯è¡Œé¢˜ç›®æ•°
            document.getElementById('perRow').value = 4;
            
            // æ¸…é™¤å·²ç”Ÿæˆçš„é¢˜ç›®
            exercises = [];
            currentPages = [];
            exerciseAnswers = [];
            exercisesGenerated = false;
            
            // æ¸…é™¤é¢„è§ˆåŒºåŸŸ
            document.getElementById('exercisesContent').innerHTML = '';
            document.getElementById('paginationInfo').textContent = '';
            document.getElementById('paginationInfo').style.display = 'none';
            
            // æ˜¾ç¤ºæç¤º
            alert('æ‰€æœ‰è®¾ç½®å·²æ¸…é™¤ï¼Œè¯·é‡æ–°é€‰æ‹©ä¸»é¢˜å¹¶ç”Ÿæˆç»ƒä¹ é¢˜ï¼');
        }
        
        // ======================================================
        // ä¿®æ”¹ç‚¹ï¼šæ”¹è¿›çš„å°æ•°è®¡ç®—å‡½æ•° - å¢åŠ åŒç±»å‹å°æ•°è¿ç®—æ¯”ä¾‹
        // ======================================================
        
        // ç”Ÿæˆå°æ•°è¿ç®—é¢˜ç›®ï¼ˆ75%ä¸ºåŒç±»å‹å°æ•°è¿ç®—ï¼šä¸€ä½å°æ•°åŠ å‡ä¸€ä½å°æ•°æˆ–ä¸¤ä½å°æ•°åŠ å‡ä¸¤ä½å°æ•°ï¼‰
        function generateMixedDecimal(operation) {
            const random = Math.random();
            
            // 75%çš„æ¦‚ç‡ç”ŸæˆåŒç±»å‹å°æ•°è¿ç®—
            if (random < 0.75) {
                // åŒç±»å‹å°æ•°è¿ç®—ï¼šä¸€ä½å°æ•°åŠ å‡ä¸€ä½å°æ•° æˆ– ä¸¤ä½å°æ•°åŠ å‡ä¸¤ä½å°æ•°
                const type = Math.random() < 0.5 ? 'one-decimal' : 'two-decimal';
                const num1 = generateDecimalByType(type);
                const num2 = generateDecimalByType(type);
                
                // å¯¹äºå‡æ³•ï¼Œç¡®ä¿è¢«å‡æ•°å¤§äºå‡æ•°
                if (operation === 'subtract' && parseFloat(num1) <= parseFloat(num2)) {
                    // äº¤æ¢ä¸¤ä¸ªæ•°
                    return { num1: num2, num2: num1, type1: type, type2: type };
                }
                
                return { num1, num2, type1: type, type2: type };
            } else {
                // 25%çš„æ¦‚ç‡ç”Ÿæˆæ··åˆç±»å‹å°æ•°
                const types = ['integer', 'one-decimal', 'two-decimal'];
                
                // éšæœºé€‰æ‹©ä¸¤ç§ä¸åŒçš„ç±»å‹
                const type1 = types[Math.floor(Math.random() * types.length)];
                let type2 = types[Math.floor(Math.random() * types.length)];
                
                // ç¡®ä¿ä¸¤ç§ç±»å‹ä¸åŒ
                while (type2 === type1) {
                    type2 = types[Math.floor(Math.random() * types.length)];
                }
                
                // ç”Ÿæˆä¸¤ä¸ªæ•°
                const num1 = generateDecimalByType(type1);
                const num2 = generateDecimalByType(type2);
                
                // å¯¹äºå‡æ³•ï¼Œç¡®ä¿è¢«å‡æ•°å¤§äºå‡æ•°
                if (operation === 'subtract' && parseFloat(num1) <= parseFloat(num2)) {
                    // å¦‚æœç±»å‹ä¸åŒï¼Œå¯èƒ½éœ€è¦è°ƒæ•´
                    if (parseFloat(num1) <= parseFloat(num2)) {
                        // äº¤æ¢ä¸¤ä¸ªæ•°ï¼ŒåŒæ—¶äº¤æ¢ç±»å‹
                        return { num1: num2, num2: num1, type1: type2, type2: type1 };
                    }
                }
                
                return { num1, num2, type1, type2 };
            }
        }
        
        // æ ¹æ®ç±»å‹ç”Ÿæˆå°æ•°
        function generateDecimalByType(type) {
            switch(type) {
                case 'integer':
                    // æ•´æ•°ï¼š1-99
                    return getRandomInt(1, 99).toString();
                case 'one-decimal':
                    // ä¸€ä½å°æ•°ï¼š0.1-9.9
                    const int1 = getRandomInt(1, 9);
                    const dec1 = getRandomInt(1, 9);
                    return `${int1}.${dec1}`;
                case 'two-decimal':
                    // ä¸¤ä½å°æ•°ï¼š0.01-9.99
                    const int2 = getRandomInt(1, 9);
                    const dec2 = getRandomInt(10, 99);
                    return `${int2}.${dec2}`;
                default:
                    return getRandomInt(1, 99).toString();
            }
        }
        
        // ======================================================
        // ä¿®æ”¹ç‚¹3ï¼šæ”¹è¿›çš„è®¡ç®—å‡½æ•°ï¼Œæ­£ç¡®å¤„ç†å°æ‹¬å·
        // ======================================================
        
        // è®¡ç®—è¡¨è¾¾å¼ç»“æœï¼ˆæ­£ç¡®å¤„ç†å°æ‹¬å·ï¼‰
        function calculateExpression(expression) {
            try {
                // æ›¿æ¢ä¸­æ–‡ç¬¦å·ä¸ºè‹±æ–‡ç¬¦å·
                let expr = expression
                    .replace(/Ã—/g, '*')
                    .replace(/Ã·/g, '/');
                
                // é¦–å…ˆè®¡ç®—æ‰€æœ‰å°æ‹¬å·å†…çš„è¡¨è¾¾å¼
                while (expr.includes('(')) {
                    // æ‰¾åˆ°æœ€å†…å±‚çš„å°æ‹¬å·
                    let start = expr.lastIndexOf('(');
                    let end = expr.indexOf(')', start);
                    
                    if (start === -1 || end === -1) break;
                    
                    // æå–å°æ‹¬å·å†…çš„è¡¨è¾¾å¼
                    const innerExpr = expr.substring(start + 1, end);
                    
                    // è®¡ç®—å°æ‹¬å·å†…çš„è¡¨è¾¾å¼ï¼ˆå…ˆä¹˜é™¤ååŠ å‡ï¼‰
                    const innerResult = calculateWithoutParentheses(innerExpr);
                    
                    // æ›¿æ¢å°æ‹¬å·åŠå…¶å†…å®¹ä¸ºè®¡ç®—ç»“æœ
                    expr = expr.substring(0, start) + innerResult + expr.substring(end + 1);
                }
                
                // è®¡ç®—æœ€ç»ˆç»“æœï¼ˆå·²æ— å°æ‹¬å·ï¼‰
                const finalResult = calculateWithoutParentheses(expr);
                
                // å¤„ç†å°æ•°ç»“æœ
                if (finalResult % 1 !== 0) {
                    // ä¿ç•™ä¸¤ä½å°æ•°
                    return parseFloat(finalResult.toFixed(2)).toString();
                }
                
                return finalResult.toString();
            } catch (error) {
                console.error('è®¡ç®—è¡¨è¾¾å¼æ—¶å‡ºé”™:', expression, error);
                return '?';
            }
        }
        
        // è®¡ç®—æ²¡æœ‰å°æ‹¬å·çš„è¡¨è¾¾å¼ï¼ˆå…ˆä¹˜é™¤ååŠ å‡ï¼‰
        function calculateWithoutParentheses(expr) {
            // å»é™¤ç©ºæ ¼
            expr = expr.replace(/\s+/g, '');
            
            // å¤„ç†ä¹˜é™¤æ³•
            const multiplyDivideRegex = /([-+]?)(\d+(?:\.\d+)?)([*/])([-+]?\d+(?:\.\d+)?)/;
            let match;
            
            while ((match = expr.match(multiplyDivideRegex))) {
                const sign = match[1] || '+';
                const left = parseFloat(match[2]);
                const operator = match[3];
                const right = parseFloat(match[4]);
                
                let result;
                if (operator === '*') {
                    result = left * right;
                } else if (operator === '/') {
                    if (right === 0) throw new Error('é™¤ä»¥é›¶é”™è¯¯');
                    result = left / right;
                }
                
                // åº”ç”¨ç¬¦å·
                if (sign === '-') {
                    result = -result;
                }
                
                // æ›¿æ¢åŒ¹é…çš„éƒ¨åˆ†ä¸ºç»“æœ
                expr = expr.replace(multiplyDivideRegex, result >= 0 ? '+' + result : result);
            }
            
            // å¤„ç†åŠ å‡æ³•
            const addSubtractRegex = /([-+]?)(\d+(?:\.\d+)?)([+-])([-+]?\d+(?:\.\d+)?)/;
            
            while ((match = expr.match(addSubtractRegex))) {
                const sign1 = match[1] || '+';
                const left = parseFloat(match[2]);
                const operator = match[3];
                const right = parseFloat(match[4]);
                
                let result;
                if (operator === '+') {
                    result = (sign1 === '+' ? left : -left) + right;
                } else if (operator === '-') {
                    result = (sign1 === '+' ? left : -left) - right;
                }
                
                // æ›¿æ¢åŒ¹é…çš„éƒ¨åˆ†ä¸ºç»“æœ
                expr = expr.replace(addSubtractRegex, result >= 0 ? '+' + result : result);
            }
            
            // è§£ææœ€ç»ˆç»“æœ
            const finalResult = parseFloat(expr);
            if (isNaN(finalResult)) {
                // å°è¯•ç›´æ¥è®¡ç®—
                return eval(expr);
            }
            
            return finalResult;
        }
        
        // ç”Ÿæˆéšæœºæ•°ï¼ˆä¿®å¤ç‰ˆï¼‰
        function getRandomInt(min, max, excludeOne = false) {
            let num;
            let attempts = 0;
            const maxAttempts = 100;
            
            do {
                num = Math.floor(Math.random() * (max - min + 1)) + min;
                attempts++;
                if (attempts > maxAttempts) {
                    // å¦‚æœå°è¯•æ¬¡æ•°è¿‡å¤šï¼Œè¿”å›ä¸€ä¸ªä¸æ’é™¤1çš„å€¼
                    return Math.floor(Math.random() * (max - min + 1)) + min;
                }
            } while (excludeOne && num === 1);
            return num;
        }
        
        // è·å–é€‰ä¸­çš„ä¸»é¢˜
        function getSelectedTopics() {
            selectedTopics = [];
            document.querySelectorAll('input[name="topic"]:checked').forEach(checkbox => {
                selectedTopics.push(checkbox.value);
            });
            return selectedTopics;
        }
        
        // æ ¹æ®éš¾åº¦è°ƒæ•´å‚æ•°
        function getDifficultyParams() {
            switch(currentDifficulty) {
                case 'easy':
                    return { maxValue: 50, numbersSimple: true, operationsSimple: true };
                case 'medium':
                    return { maxValue: 80, numbersSimple: false, operationsSimple: true };
                case 'hard':
                    return { maxValue: 99, numbersSimple: false, operationsSimple: false };
                default:
                    return { maxValue: 80, numbersSimple: false, operationsSimple: true };
            }
        }
        
        // ç”Ÿæˆä¹˜åŠ é¢˜ç›®ï¼ˆç®€åŒ–ç‰ˆï¼Œé¿å…å¡ä½ï¼‰
        function generateMultiplyAdd(usedExercises) {
            const params = getDifficultyParams();
            const a = getRandomInt(10, params.maxValue);
            const b = getRandomInt(2, 9);
            const c = getRandomInt(2, 9);
            
            let exercise;
            if (Math.random() < 0.5) {
                exercise = `${a} + ${b} Ã— ${c}`;
            } else {
                exercise = `${c} Ã— ${b} + ${a}`;
            }
            
            // è®¡ç®—ç­”æ¡ˆ
            const answer = calculateExpression(exercise);
            
            // ç®€åŒ–å»é‡é€»è¾‘ï¼šå¦‚æœé‡å¤ï¼Œä¿®æ”¹æ•°å­—é‡æ–°ç”Ÿæˆ
            if (usedExercises.has(exercise)) {
                const newA = getRandomInt(10, params.maxValue);
                const newB = getRandomInt(2, 9);
                const newC = getRandomInt(2, 9);
                
                if (Math.random() < 0.5) {
                    exercise = `${newA} + ${newB} Ã— ${newC}`;
                } else {
                    exercise = `${newC} Ã— ${newB} + ${newA}`;
                }
                
                return { exercise: exercise, answer: calculateExpression(exercise) };
            }
            
            return { exercise: exercise, answer: answer };
        }
        
        // ç”Ÿæˆä¹˜å‡é¢˜ç›®ï¼ˆç®€åŒ–ç‰ˆï¼‰
        function generateMultiplySubtract(usedExercises) {
            const params = getDifficultyParams();
            let a, b, c;
            
            do {
                a = getRandomInt(20, params.maxValue);
                b = getRandomInt(2, 9);
                c = getRandomInt(2, 9);
            } while (a <= b * c);
            
            let exercise;
            if (Math.random() < 0.5) {
                exercise = `${a} - ${b} Ã— ${c}`;
            } else {
                const d = getRandomInt(1, b * c - 1);
                exercise = `${c} Ã— ${b} - ${d}`;
            }
            
            // è®¡ç®—ç­”æ¡ˆ
            const answer = calculateExpression(exercise);
            
            // ç®€åŒ–å»é‡é€»è¾‘
            if (usedExercises.has(exercise)) {
                let newA, newB, newC;
                do {
                    newA = getRandomInt(20, params.maxValue);
                    newB = getRandomInt(2, 9);
                    newC = getRandomInt(2, 9);
                } while (newA <= newB * newC);
                
                if (Math.random() < 0.5) {
                    exercise = `${newA} - ${newB} Ã— ${newC}`;
                } else {
                    const newD = getRandomInt(1, newB * newC - 1);
                    exercise = `${newC} Ã— ${newB} - ${newD}`;
                }
                
                return { exercise: exercise, answer: calculateExpression(exercise) };
            }
            
            return { exercise: exercise, answer: answer };
        }
        
        // ç”Ÿæˆé™¤åŠ é¢˜ç›®ï¼ˆç®€åŒ–ç‰ˆï¼‰
        function generateDivideAdd(usedExercises) {
            const params = getDifficultyParams();
            const a = getRandomInt(10, params.maxValue);
            const division = getRandomTableDivision();
            const e = division[0];
            const c = division[1];
            
            let exercise;
            if (Math.random() < 0.5) {
                exercise = `${a} + ${e} Ã· ${c}`;
            } else {
                exercise = `${e} Ã· ${c} + ${a}`;
            }
            
            // è®¡ç®—ç­”æ¡ˆ
            const answer = calculateExpression(exercise);
            
            // ç®€åŒ–å»é‡é€»è¾‘
            if (usedExercises.has(exercise)) {
                const newA = getRandomInt(10, params.maxValue);
                const newDivision = getRandomTableDivision();
                const newE = newDivision[0];
                const newC = newDivision[1];
                
                if (Math.random() < 0.5) {
                    exercise = `${newA} + ${newE} Ã· ${newC}`;
                } else {
                    exercise = `${newE} Ã· ${newC} + ${newA}`;
                }
                
                return { exercise: exercise, answer: calculateExpression(exercise) };
            }
            
            return { exercise: exercise, answer: answer };
        }
        
        // è·å–éšæœºçš„è¡¨å†…é™¤æ³•
        function getRandomTableDivision() {
            const tableDivisions = [
                [4,2,2], [6,2,3], [6,3,2], [8,2,4], [8,4,2], [9,3,3],
                [10,2,5], [10,5,2], [12,2,6], [12,3,4], [12,4,3], [12,6,2],
                [14,2,7], [14,7,2], [15,3,5], [15,5,3], [16,2,8], [16,4,4],
                [16,8,2], [18,2,9], [18,3,6], [18,6,3], [18,9,2], [20,4,5],
                [20,5,4], [21,3,7], [21,7,3], [24,3,8], [24,4,6], [24,6,4],
                [24,8,3], [25,5,5], [27,3,9], [27,9,3], [28,4,7], [28,7,4],
                [30,5,6], [30,6,5], [32,4,8], [32,8,4], [35,5,7], [35,7,5],
                [36,4,9], [36,6,6], [36,9,4], [40,5,8], [40,8,5], [42,6,7],
                [42,7,6], [45,5,9], [45,9,5], [48,6,8], [48,8,6], [49,7,7],
                [54,6,9], [54,9,6], [56,7,8], [56,8,7], [63,7,9], [63,9,7],
                [64,8,8], [72,8,9], [72,9,8], [81,9,9]
            ];
            return tableDivisions[Math.floor(Math.random() * tableDivisions.length)];
        }
        
        // ======================================================
        // ä¿®æ”¹ç‚¹ï¼šä¿®å¤å¤ä¹ å•å…ƒé™¤æ³•ä¸­é™¤æ•°å¯èƒ½ä¸ºä¸¤ä½æ•°çš„é—®é¢˜
        // ======================================================
        
        // è·å–éšæœºçš„å¤ä¹ å•å…ƒé™¤æ³•ï¼ˆä¸¤ä½æ•°é™¤ä»¥ä¸€ä½æ•°ä¸”æ•´é™¤ï¼Œé™¤æ•°å¿…é¡»æ˜¯ä¸€ä½æ•°2-9ï¼‰
        function getRandomReviewDivision() {
            // è¿‡æ»¤å‡ºé™¤æ•°åœ¨2-9ä¹‹é—´çš„é™¤æ³•ç®—å¼
            const validDivisions = reviewDivisionFacts.filter(division => {
                const divisor = division[1];
                return divisor >= 2 && divisor <= 9;
            });
            
            if (validDivisions.length === 0) {
                // å¦‚æœæ²¡æœ‰ç¬¦åˆæ¡ä»¶çš„ï¼Œè¿”å›ä¸€ä¸ªé»˜è®¤çš„ç®€å•é™¤æ³•
                return [10, 2, 5];
            }
            
            return validDivisions[Math.floor(Math.random() * validDivisions.length)];
        }
        
        // ======================================================
        // ä¿®æ”¹ç‚¹ï¼šä¿®å¤é™¤å‡è¿ç®—å¡ä½é—®é¢˜
        // ======================================================
        
        // ç”Ÿæˆé™¤å‡é¢˜ç›®ï¼ˆä¿®å¤ç‰ˆï¼‰
        function generateDivideSubtract(usedExercises) {
            const params = getDifficultyParams();
            let a;
            let division;
            
            // ä¿®å¤ï¼šæ·»åŠ æœ€å¤§å°è¯•æ¬¡æ•°ï¼Œé¿å…æ— é™å¾ªç¯
            let attempts = 0;
            const maxAttempts = 50;
            
            do {
                a = getRandomInt(20, params.maxValue, false); // ä¿®å¤ï¼šä¸æ’é™¤æ•°å­—1
                division = getRandomTableDivision();
                attempts++;
                if (attempts > maxAttempts) {
                    // å¦‚æœå°è¯•æ¬¡æ•°è¿‡å¤šï¼Œä½¿ç”¨é»˜è®¤å€¼
                    a = 50;
                    division = getRandomTableDivision();
                    break;
                }
            } while (a <= division[0]);
            
            const e = division[0];
            const c = division[1];
            
            let exercise;
            if (Math.random() < 0.5) {
                exercise = `${a} - ${e} Ã· ${c}`;
            } else {
                // ä¿®å¤ï¼šç¡®ä¿å‡æ•°å°äºå•†ï¼Œä¸”ä¸ä¸º0
                const maxSubtract = Math.max(1, division[2] - 1);
                if (maxSubtract <= 0) {
                    exercise = `${a} - ${e} Ã· ${c}`; // å›é€€åˆ°ç¬¬ä¸€ç§å½¢å¼
                } else {
                    exercise = `${e} Ã· ${c} - ${getRandomInt(1, maxSubtract, false)}`; // ä¿®å¤ï¼šä¸æ’é™¤æ•°å­—1
                }
            }
            
            // è®¡ç®—ç­”æ¡ˆ
            const answer = calculateExpression(exercise);
            
            // ç®€åŒ–å»é‡é€»è¾‘
            if (usedExercises.has(exercise)) {
                let newA;
                let newDivision;
                
                attempts = 0;
                do {
                    newA = getRandomInt(20, params.maxValue, false); // ä¿®å¤ï¼šä¸æ’é™¤æ•°å­—1
                    newDivision = getRandomTableDivision();
                    attempts++;
                    if (attempts > maxAttempts) {
                        newA = 50;
                        newDivision = getRandomTableDivision();
                        break;
                    }
                } while (newA <= newDivision[0]);
                
                const newE = newDivision[0];
                const newC = newDivision[1];
                
                if (Math.random() < 0.5) {
                    exercise = `${newA} - ${newE} Ã· ${newC}`;
                } else {
                    const newMaxSubtract = Math.max(1, newDivision[2] - 1);
                    if (newMaxSubtract <= 0) {
                        exercise = `${newA} - ${newE} Ã· ${newC}`;
                    } else {
                        exercise = `${newE} Ã· ${newC} - ${getRandomInt(1, newMaxSubtract, false)}`; // ä¿®å¤ï¼šä¸æ’é™¤æ•°å­—1
                    }
                }
                
                return { exercise: exercise, answer: calculateExpression(exercise) };
            }
            
            return { exercise: exercise, answer: answer };
        }
        
        // ======================================================
        // ä¿®æ”¹ç‚¹ï¼šä¿®å¤ç”Ÿæˆå¸¦å°æ‹¬å·çš„é¢˜ç›®ä¸­å¯èƒ½äº§ç”Ÿä¸¤ä¸ªè¿ç»­è´Ÿå·çš„é—®é¢˜
        // ======================================================
        
        // ç”Ÿæˆå¸¦å°æ‹¬å·çš„é¢˜ç›®ï¼ˆä¿®å¤ç‰ˆï¼Œé¿å…å‡ºç°è¿ç»­è´Ÿå·ï¼‰
        function generateWithParentheses(usedExercises) {
            const params = getDifficultyParams();
            const types = ['add_multiply', 'subtract_multiply', 'add_divide', 'subtract_divide'];
            const type = types[Math.floor(Math.random() * types.length)];
            
            let exercise;
            
            switch(type) {
                case 'add_multiply':
                    const h1 = getRandomInt(2, 5);
                    const i1 = getRandomInt(2, 5);
                    const c1 = getRandomInt(2, 9);
                    if (Math.random() < 0.5) {
                        exercise = `(${h1} + ${i1}) Ã— ${c1}`;
                    } else {
                        exercise = `${c1} Ã— (${h1} + ${i1})`;
                    }
                    break;
                    
                case 'subtract_multiply':
                    let h2, i2;
                    do {
                        h2 = getRandomInt(3, 9);
                        i2 = getRandomInt(1, h2 - 1);
                    } while (h2 - i2 === 1);
                    const c2 = getRandomInt(2, 9);
                    if (Math.random() < 0.5) {
                        exercise = `(${h2} - ${i2}) Ã— ${c2}`;
                    } else {
                        exercise = `${c2} Ã— (${h2} - ${i2})`;
                    }
                    break;
                    
                case 'add_divide':
                    const multiplication = multiplicationFacts[Math.floor(Math.random() * multiplicationFacts.length)];
                    const sum = multiplication[2];
                    let j3, k3;
                    do {
                        j3 = getRandomInt(2, sum - 2);
                        k3 = sum - j3;
                    } while (j3 === 1 || k3 === 1);
                    const c3 = multiplication[0];
                    exercise = `(${j3} + ${k3}) Ã· ${c3}`;
                    break;
                    
                case 'subtract_divide':
                    const multiplication2 = multiplicationFacts[Math.floor(Math.random() * multiplicationFacts.length)];
                    const diff = multiplication2[2];
                    // ä¿®å¤ï¼šç¡®ä¿ j4 å¤§äº diffï¼Œé¿å…å‡ºç°è´Ÿæ•°
                    const j4 = getRandomInt(diff + 2, diff + 10);
                    const k4 = j4 - diff;
                    const c4 = multiplication2[0];
                    exercise = `(${j4} - ${k4}) Ã· ${c4}`;
                    break;
            }
            
            // è®¡ç®—ç­”æ¡ˆ
            const answer = calculateExpression(exercise);
            
            // ç®€åŒ–å»é‡é€»è¾‘
            if (usedExercises.has(exercise)) {
                // å¦‚æœé‡å¤ï¼Œç”Ÿæˆä¸€ä¸ªç®€å•çš„å°æ‹¬å·é¢˜ç›®
                const simpleA = getRandomInt(2, 5);
                const simpleB = getRandomInt(2, 5);
                const simpleC = getRandomInt(2, 9);
                exercise = `(${simpleA} + ${simpleB}) Ã— ${simpleC}`;
                
                return { exercise: exercise, answer: calculateExpression(exercise) };
            }
            
            return { exercise: exercise, answer: answer };
        }
        
        // ç”Ÿæˆä¸‰ä½æ•°åŠ å‡é¢˜ç›®ï¼ˆç®€åŒ–ç‰ˆï¼‰
        function generateThreeDigitOperation(usedExercises) {
            const params = getDifficultyParams();
            const operations = ['add', 'subtract', 'mixed'];
            const operation = operations[Math.floor(Math.random() * operations.length)];
            
            let exercise;
            
            switch(operation) {
                case 'add':
                    // è¿åŠ ï¼šç¡®ä¿ç»“æœä¸è¶…è¿‡1000
                    let num1, num2, num3;
                    do {
                        num1 = getRandomInt(100, 700);
                        num2 = getRandomInt(100, 700);
                        num3 = getRandomInt(100, 700);
                    } while (num1 + num2 + num3 > 1000);
                    exercise = `${num1} + ${num2} + ${num3}`;
                    break;
                    
                case 'subtract':
                    // è¿å‡ï¼šç¡®ä¿æ¯ä¸€æ­¥éƒ½ä¸ä¸ºè´Ÿæ•°
                    const large = getRandomInt(500, 999);
                    const medium = getRandomInt(200, large - 100);
                    const small = getRandomInt(100, medium - 50);
                    exercise = `${large} - ${medium} - ${small}`;
                    break;
                    
                case 'mixed':
                    // åŠ å‡æ··åˆï¼šç¡®ä¿æ¯ä¸€æ­¥éƒ½ä¸ä¸ºè´Ÿæ•°
                    const patterns = ['a + b - c', 'a - b + c'];
                    const pattern = patterns[Math.floor(Math.random() * patterns.length)];
                    
                    if (pattern === 'a + b - c') {
                        // a + b - c æ¨¡å¼
                        const sum = getRandomInt(200, 800);
                        const a1 = getRandomInt(100, sum - 100);
                        const b1 = sum - a1;
                        const c1 = getRandomInt(50, sum - 50);
                        exercise = `${a1} + ${b1} - ${c1}`;
                    } else {
                        // a - b + c æ¨¡å¼
                        const a2 = getRandomInt(200, 900);
                        const b2 = getRandomInt(100, a2 - 100);
                        const c2 = getRandomInt(50, 500);
                        exercise = `${a2} - ${b2} + ${c2}`;
                    }
                    break;
            }
            
            // è®¡ç®—ç­”æ¡ˆ
            const answer = calculateExpression(exercise);
            
            // ç®€åŒ–å»é‡é€»è¾‘
            if (usedExercises.has(exercise)) {
                // å¦‚æœé‡å¤ï¼Œç”Ÿæˆä¸€ä¸ªç®€å•çš„ä¸‰ä½æ•°åŠ æ³•
                const simple1 = getRandomInt(100, 400);
                const simple2 = getRandomInt(100, 400);
                const simple3 = getRandomInt(100, 200);
                exercise = `${simple1} + ${simple2} + ${simple3}`;
                
                return { exercise: exercise, answer: calculateExpression(exercise) };
            }
            
            return { exercise: exercise, answer: answer };
        }
        
        // ç”Ÿæˆä¸¤ä½æ•°ä¹˜ä¸€ä½æ•°é¢˜ç›®ï¼ˆç®€åŒ–ç‰ˆï¼‰
        function generateTwoDigitMultiply(usedExercises) {
            const twoDigit = getRandomInt(10, 99);
            const oneDigit = getRandomInt(2, 9);
            let exercise = `${twoDigit} Ã— ${oneDigit}`;
            
            // è®¡ç®—ç­”æ¡ˆ
            const answer = calculateExpression(exercise);
            
            // ç®€åŒ–å»é‡é€»è¾‘
            if (usedExercises.has(exercise)) {
                const newTwoDigit = getRandomInt(10, 99);
                const newOneDigit = getRandomInt(2, 9);
                exercise = `${newTwoDigit} Ã— ${newOneDigit}`;
                
                return { exercise: exercise, answer: calculateExpression(exercise) };
            }
            
            return { exercise: exercise, answer: answer };
        }
        
        // ======================================================
        // ä¿®æ”¹ç‚¹ï¼šæ”¹è¿›çš„ä¸¤ä½æ•°é™¤ä¸€ä½æ•°é¢˜ç›®ç”Ÿæˆï¼ˆç¡®ä¿æ•´é™¤ä¸”é™¤æ•°ä¸º2-9ï¼‰
        // ======================================================
        function generateTwoDigitDivide(usedExercises) {
            // ç›´æ¥ä»é¢„å®šä¹‰çš„æ•´é™¤è¡¨ä¸­éšæœºé€‰æ‹©
            const division = twoDigitDivisionFacts[Math.floor(Math.random() * twoDigitDivisionFacts.length)];
            
            const dividend = division[0]; // è¢«é™¤æ•°
            const divisor = division[1]; // é™¤æ•°ï¼ˆç¡®ä¿æ˜¯2-9ï¼‰
            
            let exercise = `${dividend} Ã· ${divisor}`;
            
            // è®¡ç®—ç­”æ¡ˆ
            const answer = calculateExpression(exercise);
            
            // ç®€åŒ–å»é‡é€»è¾‘
            if (usedExercises.has(exercise)) {
                const newDivision = twoDigitDivisionFacts[Math.floor(Math.random() * twoDigitDivisionFacts.length)];
                const newDividend = newDivision[0];
                const newDivisor = newDivision[1];
                
                exercise = `${newDividend} Ã· ${newDivisor}`;
                
                return { exercise: exercise, answer: calculateExpression(exercise) };
            }
            
            return { exercise: exercise, answer: answer };
        }
        
        // ======================================================
        // ä¿®æ”¹ç‚¹ï¼šæ”¹è¿›çš„å°æ•°åŠ æ³•é¢˜ç›®ï¼ˆ75%ä¸ºåŒç±»å‹å°æ•°è¿ç®—ï¼‰
        // ======================================================
        function generateDecimalAdd(usedExercises) {
            // ç”Ÿæˆæ··åˆç±»å‹çš„å°æ•°ï¼ˆ75%ä¸ºåŒç±»å‹è¿ç®—ï¼‰
            const { num1, num2 } = generateMixedDecimal('add');
            
            let exercise = `${num1} + ${num2}`;
            
            // è®¡ç®—ç­”æ¡ˆ
            const answer = calculateExpression(exercise);
            
            // ç®€åŒ–å»é‡é€»è¾‘
            if (usedExercises.has(exercise)) {
                const newNumbers = generateMixedDecimal('add');
                exercise = `${newNumbers.num1} + ${newNumbers.num2}`;
                
                return { exercise: exercise, answer: calculateExpression(exercise) };
            }
            
            return { exercise: exercise, answer: answer };
        }
        
        // ======================================================
        // ä¿®æ”¹ç‚¹ï¼šæ”¹è¿›çš„å°æ•°å‡æ³•é¢˜ç›®ï¼ˆ75%ä¸ºåŒç±»å‹å°æ•°è¿ç®—ï¼‰
        // ======================================================
        function generateDecimalSubtract(usedExercises) {
            // ç”Ÿæˆæ··åˆç±»å‹çš„å°æ•°ï¼ˆ75%ä¸ºåŒç±»å‹è¿ç®—ï¼‰
            const { num1, num2 } = generateMixedDecimal('subtract');
            
            let exercise = `${num1} - ${num2}`;
            
            // è®¡ç®—ç­”æ¡ˆ
            const answer = calculateExpression(exercise);
            
            // ç®€åŒ–å»é‡é€»è¾‘
            if (usedExercises.has(exercise)) {
                const newNumbers = generateMixedDecimal('subtract');
                exercise = `${newNumbers.num1} - ${newNumbers.num2}`;
                
                return { exercise: exercise, answer: calculateExpression(exercise) };
            }
            
            return { exercise: exercise, answer: answer };
        }
        
        // ======================================================
        // å¤ä¹ å•å…ƒçš„ç‰¹æ®Šç”Ÿæˆå‡½æ•°ï¼ˆç¬¦åˆæ–°è¦æ±‚ï¼‰
        // ======================================================
        
        // ç”Ÿæˆå¤ä¹ ä¹˜åŠ é¢˜ç›®ï¼ˆç¬¦åˆè¦æ±‚ï¼šä¹˜æ³•éƒ¨åˆ†ä¸€ä¸ªä¸¤ä½æ•°Ã—ä¸€ä½æ•°ï¼‰
        function generateReviewMultiplyAdd(usedExercises) {
            // ä¸¤ä½æ•°ä¹˜ä¸€ä½æ•°
            const twoDigit = getRandomInt(10, 99);
            const oneDigit = getRandomInt(2, 9);
            const product = twoDigit * oneDigit;
            
            // åŠ æ³•éƒ¨åˆ†ï¼Œç¡®ä¿éè´Ÿæ•°
            const addNum = getRandomInt(0, 99);
            
            let exercise;
            if (Math.random() < 0.5) {
                exercise = `${addNum} + ${twoDigit} Ã— ${oneDigit}`;
            } else {
                exercise = `${twoDigit} Ã— ${oneDigit} + ${addNum}`;
            }
            
            // è®¡ç®—ç­”æ¡ˆ
            const answer = calculateExpression(exercise);
            
            // ç®€åŒ–å»é‡é€»è¾‘
            if (usedExercises.has(exercise)) {
                const newTwoDigit = getRandomInt(10, 99);
                const newOneDigit = getRandomInt(2, 9);
                const newAddNum = getRandomInt(0, 99);
                
                if (Math.random() < 0.5) {
                    exercise = `${newAddNum} + ${newTwoDigit} Ã— ${newOneDigit}`;
                } else {
                    exercise = `${newTwoDigit} Ã— ${newOneDigit} + ${newAddNum}`;
                }
                
                return { exercise: exercise, answer: calculateExpression(exercise) };
            }
            
            return { exercise: exercise, answer: answer };
        }
        
        // ç”Ÿæˆå¤ä¹ ä¹˜å‡é¢˜ç›®ï¼ˆç¬¦åˆè¦æ±‚ï¼šä¹˜æ³•éƒ¨åˆ†ä¸€ä¸ªä¸¤ä½æ•°Ã—ä¸€ä½æ•°ï¼Œç¡®ä¿éè´Ÿæ•°ï¼‰
        function generateReviewMultiplySubtract(usedExercises) {
            // ä¸¤ä½æ•°ä¹˜ä¸€ä½æ•°
            const twoDigit = getRandomInt(10, 99);
            const oneDigit = getRandomInt(2, 9);
            const product = twoDigit * oneDigit;
            
            let exercise;
            // ç¬¬ä¸€ç§å½¢å¼ï¼ša - bÃ—c
            if (Math.random() < 0.5) {
                const minuend = getRandomInt(product, product + 50); // è¢«å‡æ•°è¦å¤§äºç­‰äºä¹˜ç§¯
                exercise = `${minuend} - ${twoDigit} Ã— ${oneDigit}`;
            } 
            // ç¬¬äºŒç§å½¢å¼ï¼šbÃ—c - a
            else {
                const subtrahend = getRandomInt(0, product - 1); // å‡æ•°è¦å°äºä¹˜ç§¯
                exercise = `${twoDigit} Ã— ${oneDigit} - ${subtrahend}`;
            }
            
            // è®¡ç®—ç­”æ¡ˆ
            const answer = calculateExpression(exercise);
            
            // ç®€åŒ–å»é‡é€»è¾‘
            if (usedExercises.has(exercise)) {
                const newTwoDigit = getRandomInt(10, 99);
                const newOneDigit = getRandomInt(2, 9);
                const newProduct = newTwoDigit * newOneDigit;
                
                if (Math.random() < 0.5) {
                    const newMinuend = getRandomInt(newProduct, newProduct + 50);
                    exercise = `${newMinuend} - ${newTwoDigit} Ã— ${newOneDigit}`;
                } else {
                    const newSubtrahend = getRandomInt(0, newProduct - 1);
                    exercise = `${newTwoDigit} Ã— ${newOneDigit} - ${newSubtrahend}`;
                }
                
                return { exercise: exercise, answer: calculateExpression(exercise) };
            }
            
            return { exercise: exercise, answer: answer };
        }
        
        // ======================================================
        // ä¿®æ”¹ç‚¹ï¼šå¤ä¹ é™¤åŠ é¢˜ç›®çš„å¤‡é€‰ç”Ÿæˆå‡½æ•°
        // ======================================================
        
        // å¤ä¹ é™¤åŠ é¢˜ç›®çš„å¤‡é€‰ç”Ÿæˆå‡½æ•°
        function generateReviewDivideAddFallback(usedExercises) {
            // ä½¿ç”¨ä¸€äº›ç®€å•çš„é»˜è®¤é™¤æ³•
            const simpleDivisions = [
                [12, 3, 4], [15, 3, 5], [18, 3, 6], [21, 3, 7],
                [16, 4, 4], [20, 4, 5], [24, 4, 6], [28, 4, 7],
                [25, 5, 5], [30, 5, 6], [35, 5, 7], [40, 5, 8],
                [36, 6, 6], [42, 6, 7], [48, 6, 8], [54, 6, 9]
            ];
            
            const division = simpleDivisions[Math.floor(Math.random() * simpleDivisions.length)];
            const dividend = division[0];
            const divisor = division[1];
            const addNum = getRandomInt(0, 99, false); // ä¿®å¤ï¼šä¸æ’é™¤æ•°å­—1
            
            let exercise;
            if (Math.random() < 0.5) {
                exercise = `${addNum} + ${dividend} Ã· ${divisor}`;
            } else {
                exercise = `${dividend} Ã· ${divisor} + ${addNum}`;
            }
            
            return { exercise: exercise, answer: calculateExpression(exercise) };
        }
        
        // ç”Ÿæˆå¤ä¹ é™¤åŠ é¢˜ç›®ï¼ˆä¿®å¤é™¤æ•°å¯èƒ½ä¸ºä¸¤ä½æ•°çš„é—®é¢˜ï¼‰
        function generateReviewDivideAdd(usedExercises) {
            const division = getRandomReviewDivision();
            const dividend = division[0]; // ä¸¤ä½æ•°è¢«é™¤æ•°
            const divisor = division[1]; // ä¸€ä½æ•°é™¤æ•°ï¼ˆ2-9ï¼‰
            const quotient = division[2]; // å•†
            
            // ç¡®ä¿é™¤æ•°æ˜¯ä¸€ä½æ•°ï¼ˆ2-9ï¼‰
            if (divisor < 2 || divisor > 9) {
                // å¦‚æœä¸ç¬¦åˆè¦æ±‚ï¼Œä½¿ç”¨ä¸€ä¸ªé»˜è®¤çš„é™¤æ³•
                return generateReviewDivideAddFallback(usedExercises);
            }
            
            // åŠ æ³•éƒ¨åˆ†
            const addNum = getRandomInt(0, 99, false); // ä¿®å¤ï¼šä¸æ’é™¤æ•°å­—1
            
            let exercise;
            if (Math.random() < 0.5) {
                exercise = `${addNum} + ${dividend} Ã· ${divisor}`;
            } else {
                exercise = `${dividend} Ã· ${divisor} + ${addNum}`;
            }
            
            // è®¡ç®—ç­”æ¡ˆ
            const answer = calculateExpression(exercise);
            
            // ç®€åŒ–å»é‡é€»è¾‘
            if (usedExercises.has(exercise)) {
                return generateReviewDivideAddFallback(usedExercises);
            }
            
            return { exercise: exercise, answer: answer };
        }
        
        // ======================================================
        // ä¿®æ”¹ç‚¹ï¼šå¤ä¹ é™¤å‡é¢˜ç›®çš„å¤‡é€‰ç”Ÿæˆå‡½æ•°
        // ======================================================
        
        // å¤ä¹ é™¤å‡é¢˜ç›®çš„å¤‡é€‰ç”Ÿæˆå‡½æ•°
        function generateReviewDivideSubtractFallback(usedExercises) {
            // ä½¿ç”¨ä¸€äº›ç®€å•çš„é»˜è®¤é™¤æ³•
            const simpleDivisions = [
                [12, 3, 4], [15, 3, 5], [18, 3, 6], [21, 3, 7],
                [16, 4, 4], [20, 4, 5], [24, 4, 6], [28, 4, 7],
                [25, 5, 5], [30, 5, 6], [35, 5, 7], [40, 5, 8],
                [36, 6, 6], [42, 6, 7], [48, 6, 8], [54, 6, 9]
            ];
            
            const division = simpleDivisions[Math.floor(Math.random() * simpleDivisions.length)];
            const dividend = division[0];
            const divisor = division[1];
            const quotient = division[2];
            
            let exercise;
            if (Math.random() < 0.5) {
                const minuend = getRandomInt(quotient, quotient + 50, false);
                exercise = `${minuend} - ${dividend} Ã· ${divisor}`;
            } else {
                const subtrahend = getRandomInt(0, quotient - 1, false);
                exercise = `${dividend} Ã· ${divisor} - ${subtrahend}`;
            }
            
            return { exercise: exercise, answer: calculateExpression(exercise) };
        }
        
        // ç”Ÿæˆå¤ä¹ é™¤å‡é¢˜ç›®ï¼ˆä¿®å¤é™¤æ•°å¯èƒ½ä¸ºä¸¤ä½æ•°çš„é—®é¢˜ï¼‰
        function generateReviewDivideSubtract(usedExercises) {
            const division = getRandomReviewDivision();
            const dividend = division[0]; // ä¸¤ä½æ•°è¢«é™¤æ•°
            const divisor = division[1]; // ä¸€ä½æ•°é™¤æ•°ï¼ˆ2-9ï¼‰
            const quotient = division[2]; // å•†
            
            // ç¡®ä¿é™¤æ•°æ˜¯ä¸€ä½æ•°ï¼ˆ2-9ï¼‰
            if (divisor < 2 || divisor > 9) {
                // å¦‚æœä¸ç¬¦åˆè¦æ±‚ï¼Œä½¿ç”¨ä¸€ä¸ªé»˜è®¤çš„é™¤æ³•
                return generateReviewDivideSubtractFallback(usedExercises);
            }
            
            let exercise;
            // ç¬¬ä¸€ç§å½¢å¼ï¼ša - bÃ·c
            if (Math.random() < 0.5) {
                const minuend = getRandomInt(quotient, quotient + 50, false); // è¢«å‡æ•°è¦å¤§äºç­‰äºå•†
                exercise = `${minuend} - ${dividend} Ã· ${divisor}`;
            } 
            // ç¬¬äºŒç§å½¢å¼ï¼šbÃ·c - a
            else {
                const subtrahend = getRandomInt(0, quotient - 1, false); // å‡æ•°è¦å°äºå•†
                exercise = `${dividend} Ã· ${divisor} - ${subtrahend}`;
            }
            
            // è®¡ç®—ç­”æ¡ˆ
            const answer = calculateExpression(exercise);
            
            // ç®€åŒ–å»é‡é€»è¾‘
            if (usedExercises.has(exercise)) {
                return generateReviewDivideSubtractFallback(usedExercises);
            }
            
            return { exercise: exercise, answer: answer };
        }
        
        // ======================================================
        // ä¿®æ”¹ç‚¹ï¼šä¿®å¤å¤ä¹ å°æ‹¬å·é¢˜ç›®ä¸­å¯èƒ½äº§ç”Ÿä¸¤ä¸ªè¿ç»­è´Ÿå·çš„é—®é¢˜
        // ======================================================
        
        // ç”Ÿæˆå¤ä¹ å°æ‹¬å·é¢˜ç›®ï¼ˆä¿®å¤ç‰ˆï¼Œé¿å…å‡ºç°è¿ç»­è´Ÿå·ï¼‰
        function generateReviewWithParentheses(usedExercises) {
            const types = [
                'add_multiply', 'subtract_multiply', 
                'add_divide', 'subtract_divide',
                'multiply_add', 'multiply_subtract',
                'divide_add', 'divide_subtract'
            ];
            const type = types[Math.floor(Math.random() * types.length)];
            
            let exercise;
            
            switch(type) {
                // (a + b) Ã— c æˆ– c Ã— (a + b)ï¼Œå…¶ä¸­cæ˜¯ä¸€ä½æ•°ï¼Œa+bæ˜¯ä¸¤ä½æ•°
                case 'add_multiply':
                    const add1 = getRandomInt(10, 89); // ç¡®ä¿å’Œæ˜¯ä¸¤ä½æ•°
                    const add2 = getRandomInt(1, 99 - add1);
                    const mul1 = getRandomInt(2, 9);
                    
                    if (Math.random() < 0.5) {
                        exercise = `(${add1} + ${add2}) Ã— ${mul1}`;
                    } else {
                        exercise = `${mul1} Ã— (${add1} + ${add2})`;
                    }
                    break;
                    
                // (a - b) Ã— c æˆ– c Ã— (a - b)ï¼Œç¡®ä¿a>bï¼Œcæ˜¯ä¸€ä½æ•°
                case 'subtract_multiply':
                    let sub1, sub2;
                    do {
                        sub1 = getRandomInt(11, 99);
                        sub2 = getRandomInt(1, sub1 - 1);
                    } while (sub1 - sub2 < 10); // ç¡®ä¿å·®æ˜¯ä¸¤ä½æ•°
                    const mul2 = getRandomInt(2, 9);
                    
                    if (Math.random() < 0.5) {
                        exercise = `(${sub1} - ${sub2}) Ã— ${mul2}`;
                    } else {
                        exercise = `${mul2} Ã— (${sub1} - ${sub2})`;
                    }
                    break;
                    
                // (a + b) Ã· cï¼Œå…¶ä¸­cæ˜¯ä¸€ä½æ•°ï¼Œa+bæ˜¯ä¸¤ä½æ•°ä¸”èƒ½è¢«cæ•´é™¤
                case 'add_divide':
                    const div1 = getRandomInt(2, 9);
                    const quotient1 = getRandomInt(2, 20); // å•†çš„èŒƒå›´
                    const total1 = div1 * quotient1; // a+bçš„å’Œ
                    
                    // æ‹†åˆ†å’Œä¸ºä¸¤ä¸ªæ•°
                    let add3 = getRandomInt(1, total1 - 1);
                    let add4 = total1 - add3;
                    
                    // ç¡®ä¿ä¸¤ä¸ªæ•°éƒ½æ˜¯æ­£æ•°ä¸”å’Œç­‰äºtotal1
                    if (add3 < 1 || add4 < 1) {
                        add3 = Math.max(1, add3);
                        add4 = total1 - add3;
                    }
                    
                    exercise = `(${add3} + ${add4}) Ã· ${div1}`;
                    break;
                    
                // (a - b) Ã· cï¼Œå…¶ä¸­cæ˜¯ä¸€ä½æ•°ï¼Œa-bæ˜¯æ­£æ•°ä¸”èƒ½è¢«cæ•´é™¤
                case 'subtract_divide':
                    const div2 = getRandomInt(2, 9);
                    const quotient2 = getRandomInt(1, 20); // å•†çš„èŒƒå›´
                    const diff2 = div2 * quotient2; // a-bçš„å·®
                    
                    // aè¦å¤§äºbï¼Œä¸”aæ˜¯ä¸¤ä½æ•°
                    const a2 = getRandomInt(diff2 + 10, 99); // ç¡®ä¿aæ˜¯ä¸¤ä½æ•°
                    const b2 = a2 - diff2;
                    
                    // ä¿®å¤ï¼šç¡®ä¿b2æ˜¯æ­£æ•°
                    if (b2 <= 0) {
                        const simpleAdd1 = getRandomInt(10, 40);
                        const simpleAdd2 = getRandomInt(10, 40);
                        const simpleMul = getRandomInt(2, 9);
                        exercise = `(${simpleAdd1} + ${simpleAdd2}) Ã— ${simpleMul}`;
                    } else {
                        exercise = `(${a2} - ${b2}) Ã· ${div2}`;
                    }
                    break;
                    
                // a Ã— (b + c) æˆ– (b + c) Ã— aï¼Œå…¶ä¸­aæ˜¯ä¸€ä½æ•°ï¼Œb+cæ˜¯ä¸¤ä½æ•°
                case 'multiply_add':
                    const add5 = getRandomInt(10, 89);
                    const add6 = getRandomInt(1, 99 - add5);
                    const mul3 = getRandomInt(2, 9);
                    
                    if (Math.random() < 0.5) {
                        exercise = `${mul3} Ã— (${add5} + ${add6})`;
                    } else {
                        exercise = `(${add5} + ${add6}) Ã— ${mul3}`;
                    }
                    break;
                    
                // a Ã— (b - c) æˆ– (b - c) Ã— aï¼Œå…¶ä¸­aæ˜¯ä¸€ä½æ•°ï¼Œb>cä¸”b-cæ˜¯ä¸¤ä½æ•°
                case 'multiply_subtract':
                    let sub3, sub4;
                    do {
                        sub3 = getRandomInt(11, 99);
                        sub4 = getRandomInt(1, sub3 - 1);
                    } while (sub3 - sub4 < 10);
                    const mul4 = getRandomInt(2, 9);
                    
                    if (Math.random() < 0.5) {
                        exercise = `${mul4} Ã— (${sub3} - ${sub4})`;
                    } else {
                        exercise = `(${sub3} - ${sub4}) Ã— ${mul4}`;
                    }
                    break;
                    
                // a Ã· (b + c)ï¼Œå…¶ä¸­aæ˜¯ä¸¤ä½æ•°ï¼Œb+cæ˜¯ä¸€ä½æ•°ä¸”èƒ½æ•´é™¤a
                case 'divide_add':
                    const add7 = getRandomInt(1, 8); // b
                    const add8 = getRandomInt(1, 9 - add7); // cï¼Œç¡®ä¿b+cåœ¨2-9ä¹‹é—´
                    const sum7 = add7 + add8;
                    
                    // æ‰¾èƒ½è¢«sum7æ•´é™¤çš„ä¸¤ä½æ•°
                    let dividend3;
                    do {
                        dividend3 = getRandomInt(10, 99);
                    } while (dividend3 % sum7 !== 0);
                    
                    exercise = `${dividend3} Ã· (${add7} + ${add8})`;
                    break;
                    
                // a Ã· (b - c)ï¼Œå…¶ä¸­aæ˜¯ä¸¤ä½æ•°ï¼Œb>cä¸”b-cæ˜¯ä¸€ä½æ•°ä¸”èƒ½æ•´é™¤a
                case 'divide_subtract':
                    let sub5, sub6;
                    do {
                        sub5 = getRandomInt(2, 9);
                        sub6 = getRandomInt(1, sub5 - 1);
                    } while (sub5 - sub6 < 2); // ç¡®ä¿å·®åœ¨2-9ä¹‹é—´
                    const diff3 = sub5 - sub6;
                    
                    // æ‰¾èƒ½è¢«diff3æ•´é™¤çš„ä¸¤ä½æ•°
                    let dividend4;
                    do {
                        dividend4 = getRandomInt(10, 99);
                    } while (dividend4 % diff3 !== 0);
                    
                    exercise = `${dividend4} Ã· (${sub5} - ${sub6})`;
                    break;
                    
                default:
                    // é»˜è®¤ç”Ÿæˆä¸€ä¸ªç®€å•çš„å°æ‹¬å·é¢˜ç›®
                    const simpleAdd1 = getRandomInt(10, 40);
                    const simpleAdd2 = getRandomInt(10, 40);
                    const simpleMul = getRandomInt(2, 9);
                    exercise = `(${simpleAdd1} + ${simpleAdd2}) Ã— ${simpleMul}`;
            }
            
            // è®¡ç®—ç­”æ¡ˆ
            const answer = calculateExpression(exercise);
            
            // ç®€åŒ–å»é‡é€»è¾‘
            if (usedExercises.has(exercise)) {
                // å¦‚æœé‡å¤ï¼Œç”Ÿæˆä¸€ä¸ªç®€å•çš„å°æ‹¬å·é¢˜ç›®
                const simpleA = getRandomInt(10, 40);
                const simpleB = getRandomInt(10, 40);
                const simpleC = getRandomInt(2, 9);
                exercise = `(${simpleA} + ${simpleB}) Ã— ${simpleC}`;
                
                return { exercise: exercise, answer: calculateExpression(exercise) };
            }
            
            return { exercise: exercise, answer: answer };
        }
        
        // è®¡ç®—æ¯é¡µå¯å®¹çº³çš„é¢˜ç›®æ•°é‡
        function calculateExercisesPerPage(perRow) {            const rowsPerPage = 22; // å¢åŠ æ¯é¡µè¡Œæ•°
            return rowsPerPage * perRow;
        }
        
        // å°†é¢˜ç›®åˆ†é¡µ
        function paginateExercises(exercises, perRow) {
            const exercisesPerPage = calculateExercisesPerPage(perRow);
            const pages = [];
            
            for (let i = 0; i < exercises.length; i += exercisesPerPage) {
                const pageExercises = exercises.slice(i, i + exercisesPerPage);
                pages.push(pageExercises);
            }
            
            return pages;
        }
        
        // è®¡ç®—é¢˜ç›®æœ€å¤§å­—ç¬¦é•¿åº¦
        function getMaxExerciseLength(exercises) {
            let maxLength = 0;
            exercises.forEach(exercise => {
                maxLength = Math.max(maxLength, exercise.exercise.length);
            });
            return maxLength;
        }
        
        // æ ¹æ®é¢˜ç›®é•¿åº¦è‡ªåŠ¨è°ƒæ•´å­—å· - è°ƒå°ç‰ˆ
        function calculateOptimalFontSize(maxLength, perRow) {
            let baseSize;
            
            // è°ƒå°åŸºç¡€å­—å·
            if (perRow <= 3) {
                baseSize = 18;  // åŸæ¥æ˜¯ 20
            } else if (perRow <= 4) {
                baseSize = 16;  // åŸæ¥æ˜¯ 18
            } else if (perRow <= 5) {
                baseSize = 14;  // åŸæ¥æ˜¯ 16
            } else {
                baseSize = 12;  // åŸæ¥æ˜¯ 14
            }
            
            // æ ¹æ®é¢˜ç›®é•¿åº¦è¿›ä¸€æ­¥è°ƒæ•´
            if (maxLength > 25) {
                baseSize = Math.max(10, baseSize - 4);  // æœ€å° 10px
            } else if (maxLength > 20) {
                baseSize = Math.max(12, baseSize - 3);
            } else if (maxLength > 15) {
                baseSize = Math.max(14, baseSize - 2);
            }
            
            return baseSize;
        }
        
        // ======================================================
        // ä¿®æ”¹ç‚¹2ï¼šç­”æ¡ˆé¡µé¢å­—ä½“è°ƒæ•´å‡½æ•°
        // ======================================================
        
        // è®¡ç®—ç­”æ¡ˆé¡µé¢çš„æœ€ä¼˜å­—å·ï¼ˆæ¯”é¢˜ç›®é¡µé¢å°2pxï¼‰
        function calculateOptimalAnswerFontSize(maxLength, perRow) {
            // å…ˆè®¡ç®—é¢˜ç›®é¡µé¢çš„å­—å·ï¼Œç„¶åå‡2
            const questionSize = calculateOptimalFontSize(maxLength, perRow);
            return Math.max(10, questionSize - 2); // æœ€å°10px
        }
        
        
        // æ¸²æŸ“é¢˜ç›®åˆ°é¡µé¢
        function renderExercises() {
            const perRow = parseInt(document.getElementById('perRow').value);
            const exercisesContent = document.getElementById('exercisesContent');
            const paginationInfo = document.getElementById('paginationInfo');
            
            exercisesContent.innerHTML = '';
            
            currentPages.forEach((pageExercises, pageIndex) => {
                const pageContainer = document.createElement('div');
                pageContainer.className = 'page-a4';
                pageContainer.id = `page-${pageIndex}`;
                pageContainer.style.position = 'relative'; // ç¡®ä¿å®šä½æ­£ç¡®
                
                const header = document.createElement('div');
                header.className = 'exercise-header';
                header.innerHTML = `
                    <h2>ä¸‰å¹´çº§è®¡ç®—ç»ƒä¹ </h2>
                    <div class="info">
                        <span>ç­çº§ï¼š__________</span>
                        <span>å§“åï¼š__________</span>
                        <span>å­¦å·ï¼š__________</span>
                    </div>
                `;
                pageContainer.appendChild(header);
                
                const exercisesGrid = document.createElement('div');
                exercisesGrid.className = 'exercises-grid';
                exercisesGrid.style.gridTemplateColumns = `repeat(${perRow}, 1fr)`;
                
                pageExercises.forEach(exercise => {
                    const exerciseItem = document.createElement('div');
                    exerciseItem.className = 'exercise-item';
                    exerciseItem.innerHTML = `<span>${exercise} = </span>`;
                    exercisesGrid.appendChild(exerciseItem);
                });
                
                pageContainer.appendChild(exercisesGrid);
                exercisesContent.appendChild(pageContainer);
            });
            
            if (currentPages.length > 1) {
                paginationInfo.textContent = `å…± ${exercises.length} é“é¢˜ç›®ï¼Œåˆ† ${currentPages.length} é¡µæ˜¾ç¤º`;
                paginationInfo.style.display = 'block';
            } else {
                paginationInfo.textContent = `å…± ${exercises.length} é“é¢˜ç›®`;
                paginationInfo.style.display = 'block';
            }
        }
        
        // è‡ªåŠ¨è°ƒæ•´å­—å·
        function adjustFontSize() {
            const perRow = parseInt(document.getElementById('perRow').value);
            const maxLength = getMaxExerciseLength(exercises.map(ex => ({ exercise: ex })));
            const optimalSize = calculateOptimalFontSize(maxLength, perRow);
            
            const exerciseItems = document.querySelectorAll('.exercise-item');
            exerciseItems.forEach(item => {
                item.style.fontSize = `${optimalSize}px`;
            });
        }
        
        // ======================================================
        // ä¿®æ”¹ç‚¹ï¼šä¼˜åŒ–æˆªå›¾å‡½æ•°ï¼Œæé«˜æ¸…æ™°åº¦
        // ======================================================
        
        // ä¸ºæ¯ä¸€é¡µç”Ÿæˆå•ç‹¬çš„ç»ƒä¹ é¢˜é¢„è§ˆåŒºåŸŸæˆªå›¾
        async function generatePageImages() {
            if (!exercisesGenerated) {
                alert('è¯·å…ˆç”Ÿæˆç»ƒä¹ é¢˜ï¼');
                return [];
            }
            
            const pageImages = [];
            
            for (let i = 0; i < currentPages.length; i++) {
                const pageElement = document.getElementById(`page-${i}`);
                if (!pageElement) continue;
                
                try {
                    // ç­‰å¾…é¡µé¢å®Œå…¨æ¸²æŸ“
                    await new Promise(resolve => setTimeout(resolve, 500));
                    
                    // æ·»åŠ æˆªå›¾ä¼˜åŒ–æ ·å¼
                    pageElement.classList.add('screenshot-mode');
                    
                    // ç¡®ä¿å…ƒç´ åœ¨é¡µé¢ä¸Šå¯è§
                    pageElement.style.display = 'block';
                    pageElement.style.visibility = 'visible';
                    pageElement.style.opacity = '1';
                    
                    // ä¼˜åŒ–æˆªå›¾å‚æ•°ï¼Œæé«˜æ¸…æ™°åº¦
                    const canvas = await html2canvas(pageElement, {
                        scale: 3, // æé«˜scaleå€¼ä»¥è·å¾—æ›´é«˜åˆ†è¾¨ç‡
                        useCORS: true,
                        backgroundColor: '#ffffff',
                        logging: false,
                        allowTaint: true,
                        foreignObjectRendering: false, // ç¦ç”¨foreignObjectä»¥æé«˜å…¼å®¹æ€§
                        removeContainer: true,
                        imageTimeout: 15000, // å¢åŠ å›¾ç‰‡åŠ è½½è¶…æ—¶æ—¶é—´
                        letterRendering: true, // å¯ç”¨å­—æ¯æ¸²æŸ“ä¼˜åŒ–
                        onclone: function(clonedDoc) {
                            // åœ¨å…‹éš†çš„æ–‡æ¡£ä¸­ç¡®ä¿å­—ä½“æ¸²æŸ“ä¼˜åŒ–
                            const clonedPage = clonedDoc.getElementById(`page-${i}`);
                            if (clonedPage) {
                                clonedPage.style.webkitFontSmoothing = 'antialiased';
                                clonedPage.style.mozOsxFontSmoothing = 'grayscale';
                                clonedPage.style.textRendering = 'optimizeLegibility';
                            }
                        }
                    });
                    
                    // ç§»é™¤æˆªå›¾ä¼˜åŒ–æ ·å¼
                    pageElement.classList.remove('screenshot-mode');
                    
                    const imageData = canvas.toDataURL('image/png', 1.0); // æœ€é«˜è´¨é‡
                    pageImages.push({
                        page: i + 1,
                        data: imageData
                    });
                    
                    console.log(`ç¬¬${i+1}é¡µæˆªå›¾å®Œæˆï¼Œå°ºå¯¸: ${canvas.width}x${canvas.height}ï¼Œåˆ†è¾¨ç‡: ${canvas.width/210*25.4} DPI`);
                } catch (error) {
                    console.error(`ç”Ÿæˆç¬¬${i+1}é¡µå›¾ç‰‡æ—¶å‡ºé”™:`, error);
                    // ç§»é™¤æˆªå›¾ä¼˜åŒ–æ ·å¼
                    pageElement.classList.remove('screenshot-mode');
                }
            }
            
            return pageImages;
        }
        
        // ç”Ÿæˆç­”æ¡ˆé¡µé¢
        function createAnswerPages() {
            if (!exercisesGenerated || exercises.length === 0) {
                alert('è¯·å…ˆç”Ÿæˆç»ƒä¹ é¢˜ï¼');
                return null;
            }
            
            const perRow = parseInt(document.getElementById('perRow').value);
            const answerPages = paginateExercises(exercises, perRow);
            const answerAnswerPages = paginateExercises(exerciseAnswers, perRow);
            
            return { answerPages, answerAnswerPages };
        }
        
        // ======================================================
        // ä¿®æ”¹ç‚¹2ï¼šæ”¹è¿›çš„æ¸²æŸ“ç­”æ¡ˆé¡µé¢å‡½æ•°ï¼ˆä½¿ç”¨æ›´å°å­—å·ï¼‰
        // ======================================================
        function renderAnswerPages() {
            const result = createAnswerPages();
            if (!result) return null;
            
            const { answerPages, answerAnswerPages } = result;
            const perRow = parseInt(document.getElementById('perRow').value);
            const maxLength = getMaxExerciseLength(exercises.map(ex => ({ exercise: ex })));
            const optimalAnswerSize = calculateOptimalAnswerFontSize(maxLength, perRow);
            
            const answerContainer = document.createElement('div');
            answerContainer.id = 'answerContainer';
            answerContainer.style.position = 'absolute';
            answerContainer.style.left = '-9999px';
            answerContainer.style.top = '0';
            answerContainer.style.width = '210mm';
            answerContainer.style.zIndex = '-1000';
            
            // æ·»åŠ å°å­—å·æ ·å¼ç±»
            answerContainer.classList.add('small-font');
            
            document.body.appendChild(answerContainer);
            
            answerPages.forEach((pageExercises, pageIndex) => {
                const pageAnswers = answerAnswerPages[pageIndex] || [];
                const pageContainer = document.createElement('div');
                pageContainer.className = 'answer-page-a4';
                pageContainer.id = `answer-page-${pageIndex}`;
                pageContainer.style.position = 'relative';
                
                const header = document.createElement('div');
                header.className = 'answer-header';
                header.innerHTML = `
                    <h2>ä¸‰å¹´çº§è®¡ç®—ç»ƒä¹ ç­”æ¡ˆ</h2>
                    <div class="info">
                        <span>ç­çº§ï¼š__________</span>
                        <span>å§“åï¼š__________</span>
                        <span>å­¦å·ï¼š__________</span>
                    </div>
                `;
                pageContainer.appendChild(header);
                
                const answersGrid = document.createElement('div');
                answersGrid.className = 'answers-grid';
                answersGrid.style.gridTemplateColumns = `repeat(${perRow}, 1fr)`;
                
                pageExercises.forEach((exercise, idx) => {
                    const answer = pageAnswers[idx] || '';
                    const answerItem = document.createElement('div');
                    answerItem.className = 'answer-item';
                    answerItem.style.fontSize = `${optimalAnswerSize}px`;
                    answerItem.innerHTML = `<span>${exercise} = ${answer}</span>`;
                    answersGrid.appendChild(answerItem);
                });
                
                pageContainer.appendChild(answersGrid);
                answerContainer.appendChild(pageContainer);
            });
            
            return answerContainer;
        }
        
        // ======================================================
        // ä¿®æ”¹ç‚¹ï¼šä¼˜åŒ–ç­”æ¡ˆæˆªå›¾å‡½æ•°ï¼Œæé«˜æ¸…æ™°åº¦
        // ======================================================
        
        // å¯¼å‡ºç­”æ¡ˆä¸ºå›¾ç‰‡ZIP
        async function exportAnswers() {
            if (!exercisesGenerated) {
                alert('è¯·å…ˆç”Ÿæˆç»ƒä¹ é¢˜ï¼');
                return;
            }
            
            document.getElementById('loadingIndicator').classList.add('active');
            document.getElementById('loadingIndicator').textContent = 'æ­£åœ¨ç”Ÿæˆç­”æ¡ˆæˆªå›¾ï¼Œè¯·ç¨å€™...';
            
            try {
                // æ¸²æŸ“ç­”æ¡ˆé¡µé¢
                const answerContainer = renderAnswerPages();
                if (!answerContainer) {
                    document.getElementById('loadingIndicator').classList.remove('active');
                    return;
                }
                
                // ç­‰å¾…DOMæ›´æ–°
                await new Promise(resolve => setTimeout(resolve, 800));
                
                const answerPages = document.querySelectorAll('.answer-page-a4');
                const pageImages = [];
                
                for (let i = 0; i < answerPages.length; i++) {
                    const pageElement = answerPages[i];
                    if (!pageElement) continue;
                    
                    try {
                        // ç­‰å¾…é¡µé¢å®Œå…¨æ¸²æŸ“
                        await new Promise(resolve => setTimeout(resolve, 500));
                        
                        // æ·»åŠ æˆªå›¾ä¼˜åŒ–æ ·å¼
                        pageElement.classList.add('screenshot-mode');
                        
                        // ç¡®ä¿å…ƒç´ åœ¨é¡µé¢ä¸Šå¯è§
                        pageElement.style.display = 'block';
                        pageElement.style.visibility = 'visible';
                        pageElement.style.opacity = '1';
                        
                        // ä¼˜åŒ–æˆªå›¾å‚æ•°ï¼Œæé«˜æ¸…æ™°åº¦
                        const canvas = await html2canvas(pageElement, {
                            scale: 3, // æé«˜scaleå€¼ä»¥è·å¾—æ›´é«˜åˆ†è¾¨ç‡
                            useCORS: true,
                            backgroundColor: '#ffffff',
                            logging: false,
                            allowTaint: true,
                            foreignObjectRendering: false,
                            removeContainer: true,
                            imageTimeout: 15000,
                            letterRendering: true,
                            onclone: function(clonedDoc) {
                                // åœ¨å…‹éš†çš„æ–‡æ¡£ä¸­ç¡®ä¿å­—ä½“æ¸²æŸ“ä¼˜åŒ–
                                const clonedPage = clonedDoc.getElementById(`answer-page-${i}`);
                                if (clonedPage) {
                                    clonedPage.style.webkitFontSmoothing = 'antialiased';
                                    clonedPage.style.mozOsxFontSmoothing = 'grayscale';
                                    clonedPage.style.textRendering = 'optimizeLegibility';
                                }
                            }
                        });
                        
                        // ç§»é™¤æˆªå›¾ä¼˜åŒ–æ ·å¼
                        pageElement.classList.remove('screenshot-mode');
                        
                        const imageData = canvas.toDataURL('image/png', 1.0); // æœ€é«˜è´¨é‡
                        pageImages.push({
                            page: i + 1,
                            data: imageData
                        });
                        
                        console.log(`ç­”æ¡ˆç¬¬${i+1}é¡µæˆªå›¾å®Œæˆï¼Œå°ºå¯¸: ${canvas.width}x${canvas.height}ï¼Œåˆ†è¾¨ç‡: ${canvas.width/210*25.4} DPI`);
                    } catch (error) {
                        console.error(`ç”Ÿæˆç­”æ¡ˆç¬¬${i+1}é¡µå›¾ç‰‡æ—¶å‡ºé”™:`, error);
                        // ç§»é™¤æˆªå›¾ä¼˜åŒ–æ ·å¼
                        pageElement.classList.remove('screenshot-mode');
                    }
                }
                
                if (pageImages.length === 0) {
                    alert('æ— æ³•ç”Ÿæˆç­”æ¡ˆæˆªå›¾ï¼Œè¯·é‡è¯•ï¼');
                    document.getElementById('loadingIndicator').classList.remove('active');
                    // ç§»é™¤ç­”æ¡ˆå®¹å™¨
                    if (answerContainer && answerContainer.parentNode) {
                        answerContainer.parentNode.removeChild(answerContainer);
                    }
                    return;
                }
                
                const zip = new JSZip();
                const dateStr = new Date().toISOString().slice(0, 10);
                
                pageImages.forEach((img, index) => {
                    const base64Data = img.data.split(',')[1];
                    zip.file(`ä¸‰å¹´çº§è®¡ç®—ç»ƒä¹ ç­”æ¡ˆ-ç¬¬${img.page}é¡µ-${dateStr}.png`, base64Data, {base64: true});
                });
                
                const zipBlob = await zip.generateAsync({type: 'blob'});
                saveAs(zipBlob, `ä¸‰å¹´çº§è®¡ç®—ç»ƒä¹ ç­”æ¡ˆ-${dateStr}.zip`);
                
                // ç§»é™¤ç­”æ¡ˆå®¹å™¨
                if (answerContainer && answerContainer.parentNode) {
                    answerContainer.parentNode.removeChild(answerContainer);
                }
                
                document.getElementById('loadingIndicator').classList.remove('active');
                document.getElementById('loadingIndicator').textContent = 'æ­£åœ¨ç”Ÿæˆé¢˜ç›®ï¼Œè¯·ç¨å€™...';
                
            } catch (error) {
                console.error('å¯¼å‡ºç­”æ¡ˆZIPæ–‡ä»¶æ—¶å‡ºé”™:', error);
                alert('å¯¼å‡ºç­”æ¡ˆå¤±è´¥ï¼Œè¯·é‡è¯•ï¼');
                document.getElementById('loadingIndicator').classList.remove('active');
                document.getElementById('loadingIndicator').textContent = 'æ­£åœ¨ç”Ÿæˆé¢˜ç›®ï¼Œè¯·ç¨å€™...';
                
                // ç¡®ä¿ç§»é™¤ç­”æ¡ˆå®¹å™¨
                const answerContainer = document.getElementById('answerContainer');
                if (answerContainer && answerContainer.parentNode) {
                    answerContainer.parentNode.removeChild(answerContainer);
                }
            }
        }
        
        // å¯¼å‡ºä¸ºZIPåŒ… - ç›´æ¥æˆªå–ç»ƒä¹ é¢˜é¢„è§ˆåŒºåŸŸ
        async function exportToImagesZip() {
            if (currentPages.length === 0 || !exercisesGenerated) {
                alert('è¯·å…ˆç”Ÿæˆç»ƒä¹ é¢˜ï¼');
                return;
            }
            
            document.getElementById('loadingIndicator').classList.add('active');
            document.getElementById('loadingIndicator').textContent = 'æ­£åœ¨ç”Ÿæˆæˆªå›¾ï¼Œè¯·ç¨å€™...';
            
            try {
                // ç¡®ä¿é¡µé¢å®Œå…¨æ¸²æŸ“
                await new Promise(resolve => setTimeout(resolve, 800));
                
                const pageImages = await generatePageImages();
                
                if (pageImages.length === 0) {
                    alert('æ— æ³•ç”Ÿæˆæˆªå›¾ï¼Œè¯·é‡è¯•ï¼');
                    return;
                }
                
                const zip = new JSZip();
                const dateStr = new Date().toISOString().slice(0, 10);
                
                pageImages.forEach((img, index) => {
                    const base64Data = img.data.split(',')[1];
                    zip.file(`ä¸‰å¹´çº§è®¡ç®—ç»ƒä¹ -ç¬¬${img.page}é¡µ-${dateStr}.png`, base64Data, {base64: true});
                });
                
                const zipBlob = await zip.generateAsync({type: 'blob'});
                saveAs(zipBlob, `ä¸‰å¹´çº§è®¡ç®—ç»ƒä¹ -${dateStr}.zip`);
                
                document.getElementById('loadingIndicator').classList.remove('active');
                document.getElementById('loadingIndicator').textContent = 'æ­£åœ¨ç”Ÿæˆé¢˜ç›®ï¼Œè¯·ç¨å€™...';
                
            } catch (error) {
                console.error('å¯¼å‡ºZIPæ–‡ä»¶æ—¶å‡ºé”™:', error);
                alert('å¯¼å‡ºå¤±è´¥ï¼Œè¯·é‡è¯•ï¼');
                document.getElementById('loadingIndicator').classList.remove('active');
                document.getElementById('loadingIndicator').textContent = 'æ­£åœ¨ç”Ÿæˆé¢˜ç›®ï¼Œè¯·ç¨å€™...';
            }
        }
        
        // ======================================================
        // ä¿®æ”¹ç‚¹ï¼šä¼˜åŒ–æ‰“å°å‡½æ•°ï¼Œæé«˜æ‰“å°æ¸…æ™°åº¦
        // ======================================================
        
        // ç›´æ¥æ‰“å° - ä½¿ç”¨ç»ƒä¹ é¢˜é¢„è§ˆåŒºåŸŸæˆªå›¾
        async function printExercises() {
            if (currentPages.length === 0 || !exercisesGenerated) {
                alert('è¯·å…ˆç”Ÿæˆç»ƒä¹ é¢˜ï¼');
                return;
            }
            
            document.getElementById('loadingIndicator').classList.add('active');
            document.getElementById('loadingIndicator').textContent = 'æ­£åœ¨å‡†å¤‡æ‰“å°ï¼Œè¯·ç¨å€™...';
            
            try {
                // ç¡®ä¿é¡µé¢å®Œå…¨æ¸²æŸ“
                await new Promise(resolve => setTimeout(resolve, 800));
                
                const pageImages = await generatePageImages();
                
                if (pageImages.length === 0) {
                    alert('æ— æ³•ç”Ÿæˆæ‰“å°å†…å®¹ï¼Œè¯·é‡è¯•ï¼');
                    return;
                }
                
                const printWindow = window.open('', '_blank');
                printWindow.document.open();
                
                let printHTML = `
                    <!DOCTYPE html>
                    <html>
                    <head>
                        <title>ä¸‰å¹´çº§è®¡ç®—ç»ƒä¹  - æ‰“å°</title>
                        <meta name="viewport" content="width=device-width, initial-scale=1.0">
                        <style>
                            body { 
                                margin: 0; 
                                padding: 0; 
                                background: white;
                                -webkit-font-smoothing: antialiased;
                                -moz-osx-font-smoothing: grayscale;
                                text-rendering: optimizeLegibility;
                            }
                            .print-page {
                                width: 210mm;
                                height: 297mm;
                                page-break-after: always;
                                display: flex;
                                justify-content: center;
                                align-items: center;
                                background: white;
                            }
                            .print-page:last-child {
                                page-break-after: auto;
                            }
                            .print-page img {
                                width: 100%;
                                height: 100%;
                                object-fit: contain;
                                display: block;
                            }
                            @media print {
                                body { 
                                    margin: 0; 
                                    padding: 0;
                                }
                                .print-page {
                                    width: 100%;
                                    height: 100%;
                                    page-break-inside: avoid;
                                }
                                @page {
                                    margin: 0;
                                    size: A4 portrait;
                                }
                            }
                        </style>
                    </head>
                    <body>
                `;
                
                pageImages.forEach(img => {
                    printHTML += `
                        <div class="print-page">
                            <img src="${img.data}" alt="ä¸‰å¹´çº§è®¡ç®—ç»ƒä¹  ç¬¬${img.page}é¡µ" style="max-width: 100%; max-height: 100%;">
                        </div>
                    `;
                });
                
                printHTML += `
                    </body>
                    </html>
                `;
                
                printWindow.document.write(printHTML);
                printWindow.document.close();
                
                // ç­‰å¾…å›¾ç‰‡åŠ è½½å®Œæˆ
                setTimeout(() => {
                    printWindow.focus();
                    printWindow.print();
                    
                    // æ‰“å°å®Œæˆåå…³é—­çª—å£
                    printWindow.onafterprint = function() {
                        setTimeout(() => {
                            printWindow.close();
                        }, 500);
                    };
                }, 1000);
                
                document.getElementById('loadingIndicator').classList.remove('active');
                document.getElementById('loadingIndicator').textContent = 'æ­£åœ¨ç”Ÿæˆé¢˜ç›®ï¼Œè¯·ç¨å€™...';
                
            } catch (error) {
                console.error('æ‰“å°æ—¶å‡ºé”™:', error);
                alert('æ‰“å°å¤±è´¥ï¼Œè¯·é‡è¯•ï¼');
                document.getElementById('loadingIndicator').classList.remove('active');
                document.getElementById('loadingIndicator').textContent = 'æ­£åœ¨ç”Ÿæˆé¢˜ç›®ï¼Œè¯·ç¨å€™...';
            }
        }
    </script>
</body>
</html>